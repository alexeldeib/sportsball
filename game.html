<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NFL Roster Quiz - Daily Challenge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèà</text></svg>" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-deep: #030712;
      --bg-card: #0f172a;
      --bg-elevated: #1e293b;
      --accent: #d97706;
      --accent-glow: rgba(217, 119, 6, 0.4);
      --accent-subtle: rgba(217, 119, 6, 0.15);
      --success: #22c55e;
      --error: #ef4444;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-subtle: rgba(148, 163, 184, 0.15);
      --border-accent: rgba(217, 119, 6, 0.5);
    }

    body {
      font-family: 'Source Sans 3', system-ui, sans-serif;
      background: var(--bg-deep);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    .bg-layer {
      position: fixed;
      inset: 0;
      z-index: -1;
      background:
        radial-gradient(ellipse 80% 60% at 50% 0%, rgba(217, 119, 6, 0.08), transparent 50%),
        radial-gradient(ellipse 60% 40% at 100% 100%, rgba(217, 119, 6, 0.05), transparent),
        var(--bg-deep);
    }

    .container {
      max-width: 580px;
      margin: 0 auto;
      padding: 2rem 1.25rem 3rem;
    }

    header {
      text-align: center;
      margin-bottom: 1.25rem;
    }

    h1 {
      font-family: 'Oswald', sans-serif;
      font-size: 1.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 0.25rem;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    /* Difficulty selector */
    .difficulty-bar {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }

    .difficulty-bar label {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .difficulty-bar select {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      color: var(--text-primary);
      padding: 0.5rem 0.75rem;
      font-family: inherit;
      font-size: 0.85rem;
    }

    .difficulty-bar select:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Progress dots */
    .progress {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1.25rem;
      flex-wrap: wrap;
    }

    .progress-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 2px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Oswald', sans-serif;
      font-size: 0.8rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .progress-dot.current {
      border-color: var(--accent);
      background: var(--accent-subtle);
      box-shadow: 0 0 12px var(--accent-glow);
    }

    .progress-dot.correct {
      border-color: var(--success);
      background: rgba(34, 197, 94, 0.2);
    }

    .progress-dot.wrong {
      border-color: var(--error);
      background: rgba(239, 68, 68, 0.2);
    }

    /* Question card */
    .question-card {
      position: relative;
      padding: 1.5rem;
      border-radius: 14px;
      background: linear-gradient(145deg, rgba(217, 119, 6, 0.12), var(--bg-card) 40%);
      border: 1px solid var(--border-accent);
      box-shadow:
        0 4px 20px rgba(0, 0, 0, 0.3),
        0 0 40px var(--accent-subtle);
    }

    .question-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), transparent);
      border-radius: 14px 14px 0 0;
    }

    .question-label {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--accent);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }

    .question-main {
      font-family: 'Oswald', sans-serif;
      font-size: 1.75rem;
      font-weight: 500;
      margin-bottom: 0.25rem;
      letter-spacing: 0.01em;
    }

    .question-sub {
      font-size: 0.95rem;
      color: var(--text-secondary);
      margin-bottom: 1.25rem;
    }

    .answer-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .field {
      flex: 1 1 140px;
    }

    .field label {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
    }

    input[type="text"] {
      width: 100%;
      background: var(--bg-deep);
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      padding: 0.7rem 1rem;
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.2s ease;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-subtle);
    }

    button.primary {
      width: 100%;
      border-radius: 8px;
      padding: 0.85rem 1rem;
      border: none;
      cursor: pointer;
      font-family: 'Oswald', sans-serif;
      font-size: 1rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: linear-gradient(135deg, var(--accent), #ea580c);
      color: white;
      box-shadow: 0 4px 15px var(--accent-glow);
      transition: all 0.2s ease;
    }

    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px var(--accent-glow);
    }

    button.secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      padding: 0.75rem 1.25rem;
      font-family: 'Oswald', sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    button.secondary:hover {
      border-color: var(--accent);
      background: var(--accent-subtle);
    }

    .feedback-card {
      margin-top: 1rem;
      padding: 0.875rem 1rem;
      border-radius: 10px;
      font-size: 0.95rem;
      display: none;
      border-left: 3px solid;
    }

    .feedback-card.visible {
      display: block;
    }

    .feedback-card.correct {
      background: rgba(34, 197, 94, 0.12);
      border-left-color: var(--success);
      color: #bbf7d0;
    }

    .feedback-card.incorrect {
      background: rgba(239, 68, 68, 0.12);
      border-left-color: var(--error);
      color: #fecaca;
    }

    .feedback-title {
      font-family: 'Oswald', sans-serif;
      font-weight: 500;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .feedback-answer {
      margin-top: 0.25rem;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    /* Results screen */
    .results {
      text-align: center;
      display: none;
      padding: 1.5rem;
      border-radius: 14px;
      background: linear-gradient(145deg, rgba(217, 119, 6, 0.12), var(--bg-card) 40%);
      border: 1px solid var(--border-accent);
    }

    .results.visible {
      display: block;
    }

    .results h2 {
      font-family: 'Oswald', sans-serif;
      font-size: 1.5rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 0.5rem;
    }

    .results-score {
      font-family: 'Oswald', sans-serif;
      font-size: 3.5rem;
      font-weight: 700;
      color: var(--accent);
      margin: 1rem 0;
    }

    .results-emoji {
      font-size: 1.5rem;
      letter-spacing: 0.15rem;
      margin-bottom: 1.5rem;
      word-break: break-all;
    }

    .share-box {
      background: var(--bg-deep);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      font-family: monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      text-align: left;
      color: var(--text-secondary);
    }

    .buttons-row {
      display: flex;
      gap: 0.75rem;
      justify-content: center;
      flex-wrap: wrap;
    }

    .buttons-row a {
      color: inherit;
      text-decoration: none;
    }

    .copied {
      color: var(--success);
      font-size: 0.85rem;
      margin-top: 0.75rem;
    }

    .footer {
      margin-top: 2rem;
      padding-top: 1.25rem;
      border-top: 1px solid var(--border-subtle);
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .footer a {
      color: var(--text-secondary);
      text-decoration: none;
      transition: color 0.2s ease;
    }

    .footer a:hover {
      color: var(--accent);
    }

    @media (max-width: 400px) {
      .container { padding: 1.5rem 1rem 2rem; }
      .question-main { font-size: 1.5rem; }
      .progress-dot { width: 28px; height: 28px; font-size: 0.75rem; }
      .results-score { font-size: 2.5rem; }
    }
  </style>
</head>
<body>
<div class="bg-layer"></div>

<div class="container">
  <header>
    <h1>Daily Challenge</h1>
    <p class="subtitle">10 questions, same for everyone today</p>
  </header>

  <div class="difficulty-bar">
    <label for="difficulty">Difficulty:</label>
    <select id="difficulty">
      <option value="50">Casual (Top 50)</option>
      <option value="100">Easy (Top 100)</option>
      <option value="200" selected>Medium (Top 200)</option>
      <option value="350">Hard (Top 350)</option>
      <option value="500">Diehard (Top 500)</option>
      <option value="750">Insane (Top 750)</option>
    </select>
  </div>

  <div class="progress" id="progress"></div>

  <div id="game-area">
    <div class="question-card" id="question-card">
      <div class="question-label" id="question-label">Question 1 of 10</div>
      <div class="question-main" id="question-main">Loading...</div>
      <div class="question-sub" id="question-sub"></div>

      <div class="answer-row">
        <div class="field" id="field-name" style="display:none;">
          <label for="input-name">Player name</label>
          <input id="input-name" type="text" placeholder="e.g. Patrick Mahomes" autocomplete="off" />
        </div>
        <div class="field" id="field-team" style="display:none;">
          <label for="input-team">Team</label>
          <input id="input-team" type="text" placeholder="e.g. Chiefs" autocomplete="off" />
        </div>
        <div class="field" id="field-pos" style="display:none;">
          <label for="input-pos">Position</label>
          <input id="input-pos" type="text" placeholder="e.g. QB" autocomplete="off" />
        </div>
      </div>

      <button class="primary" id="btn-submit">Submit</button>

      <div class="feedback-card" id="feedback-card">
        <div class="feedback-title" id="feedback-title"></div>
        <div class="feedback-answer" id="feedback-answer"></div>
      </div>
    </div>
  </div>

  <div class="results" id="results">
    <h2>Challenge Complete!</h2>
    <div class="results-score" id="results-score">0/10</div>
    <div class="results-emoji" id="results-emoji"></div>
    <div class="share-box" id="share-box"></div>
    <div class="buttons-row">
      <button class="primary" id="btn-copy">Copy Results</button>
      <button class="secondary"><a href="practice.html">Practice Mode</a></button>
    </div>
    <div class="copied" id="copied" style="display:none;">Copied to clipboard!</div>
  </div>

  <div class="footer">
    <a href="index.html">Home</a> ¬∑ <a href="practice.html">Practice</a> ¬∑ <a href="easy.html">Multiple Choice</a> ¬∑ <a href="trivia.html">Trivia</a> ¬∑ <a href="team-study.html">Depth Charts</a> ¬∑ <a href="stats-quiz.html">Stats Quiz</a> ¬∑ <a href="explorer.html">SQL Explorer</a>
  </div>
</div>

<script>
  const POSITION_MAP = {
    QB: "Quarterback", RB: "Running Back", FB: "Fullback", WR: "Wide Receiver",
    TE: "Tight End", OL: "Offensive Lineman", OT: "Offensive Tackle", C: "Center",
    G: "Guard", T: "Tackle", DL: "Defensive Lineman", DE: "Defensive End",
    DT: "Defensive Tackle", NT: "Nose Tackle", EDGE: "Edge Rusher", LB: "Linebacker",
    OLB: "Outside Linebacker", ILB: "Inside Linebacker", MLB: "Middle Linebacker",
    DB: "Defensive Back", CB: "Cornerback", S: "Safety", FS: "Free Safety",
    SS: "Strong Safety", K: "Kicker", P: "Punter", LS: "Long Snapper"
  };

  const POS_CANON = {
    qb: "QB", quarterback: "QB", rb: "RB", runningback: "RB", fb: "FB", fullback: "FB",
    wr: "WR", widereceiver: "WR", receiver: "WR", te: "TE", tightend: "TE",
    ol: "OL", offensivelineman: "OL", offensiveline: "OL", ot: "OT", offensivetackle: "OT",
    c: "C", center: "C", g: "G", guard: "G", t: "T", tackle: "T",
    dl: "DL", defensivelineman: "DL", defensiveline: "DL", de: "DE", defensiveend: "DE",
    dt: "DT", defensivetackle: "DT", nt: "NT", nosetackle: "NT",
    edge: "EDGE", edgerusher: "EDGE", lb: "LB", linebacker: "LB",
    olb: "OLB", outsidelinebacker: "OLB", ilb: "ILB", insidelinebacker: "ILB",
    mlb: "MLB", middlelinebacker: "MLB", db: "DB", defensiveback: "DB",
    cb: "CB", cornerback: "CB", s: "S", safety: "S", fs: "FS", freesafety: "FS",
    ss: "SS", strongsafety: "SS", k: "K", kicker: "K", p: "P", punter: "P",
    ls: "LS", longsnapper: "LS"
  };

  const TOTAL_QUESTIONS = 10;
  const DEFAULT_JSON_URL = "players-with-stats-2025.json";
  const STORAGE_KEY_DIFF = "nflGameDiff_v1";
  const STORAGE_KEY_DAILY = "nflGameDaily_v1";
  const DIFFICULTY_NAMES = {
    "50": "Casual", "100": "Easy", "200": "Medium",
    "350": "Hard", "500": "Diehard", "750": "Insane"
  };

  let allPlayers = [];
  let players = [];
  let topN = 200;
  let gameQuestions = [];
  let currentIndex = 0;
  let results = [];
  let awaitingNext = false;

  const difficultySelect = document.getElementById("difficulty");
  const progressEl = document.getElementById("progress");
  const questionLabel = document.getElementById("question-label");
  const questionMain = document.getElementById("question-main");
  const questionSub = document.getElementById("question-sub");
  const fieldName = document.getElementById("field-name");
  const fieldTeam = document.getElementById("field-team");
  const fieldPos = document.getElementById("field-pos");
  const inputName = document.getElementById("input-name");
  const inputTeam = document.getElementById("input-team");
  const inputPos = document.getElementById("input-pos");
  const btnSubmit = document.getElementById("btn-submit");
  const feedbackCard = document.getElementById("feedback-card");
  const feedbackTitle = document.getElementById("feedback-title");
  const feedbackAnswer = document.getElementById("feedback-answer");
  const gameArea = document.getElementById("game-area");
  const resultsEl = document.getElementById("results");
  const resultsScore = document.getElementById("results-score");
  const resultsEmoji = document.getElementById("results-emoji");
  const shareBox = document.getElementById("share-box");
  const btnCopy = document.getElementById("btn-copy");
  const copiedEl = document.getElementById("copied");

  function normalizeString(str) {
    return String(str || "").trim().toLowerCase().replace(/\s+/g, "");
  }

  function levenshtein(a, b) {
    const m = a.length, n = b.length;
    const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;
    for (let i = 1; i <= m; i++) {
      for (let j = 1; j <= n; j++) {
        if (a[i-1] === b[j-1]) dp[i][j] = dp[i-1][j-1];
        else dp[i][j] = 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
      }
    }
    return dp[m][n];
  }

  function fuzzyMatch(guess, correct) {
    if (!guess || !correct) return false;
    if (guess === correct) return true;
    if (correct.endsWith(guess) && guess.length >= 5) return true;
    const len = correct.length;
    if (len <= 3) return false;
    const dist = levenshtein(guess, correct);
    const maxDist = len <= 6 ? 1 : 2;
    return dist <= maxDist;
  }

  function canonicalizePosition(input) {
    const trimmed = normalizeString(input);
    if (!trimmed) return "";
    if (POS_CANON[trimmed]) return POS_CANON[trimmed];
    const abbr = input.toUpperCase().replace(/[^A-Z]/g, "");
    if (POSITION_MAP[abbr]) return abbr;
    return abbr;
  }

  function displayPosition(abbr) {
    const key = String(abbr || "").toUpperCase();
    const full = POSITION_MAP[key];
    return full ? key + " ‚Äî " + full : key;
  }

  function seededRandom(seed) {
    const x = Math.sin(seed++) * 10000;
    return x - Math.floor(x);
  }

  function getDaySeed() {
    const now = new Date();
    return now.getUTCFullYear() * 10000 + (now.getUTCMonth() + 1) * 100 + now.getUTCDate();
  }

  function getDailyKey() {
    return `${getDaySeed()}_${topN}`;
  }

  function saveDailyResults() {
    try {
      const data = { key: getDailyKey(), results: results, completed: results.length === TOTAL_QUESTIONS };
      localStorage.setItem(STORAGE_KEY_DAILY, JSON.stringify(data));
    } catch(e) {}
  }

  function loadDailyResults() {
    try {
      const data = JSON.parse(localStorage.getItem(STORAGE_KEY_DAILY));
      if (data && data.key === getDailyKey() && data.completed) {
        return data.results;
      }
    } catch(e) {}
    return null;
  }

  function shuffleWithSeed(array, seed) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
      seed++;
      const j = Math.floor(seededRandom(seed) * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function generateDailyQuestions() {
    const seed = getDaySeed();
    const shuffled = shuffleWithSeed(players, seed);
    const selected = shuffled.slice(0, TOTAL_QUESTIONS);

    gameQuestions = selected.map((player, i) => {
      const typeSeed = seed + 1000 + i;
      const isNameToTeam = seededRandom(typeSeed) > 0.5;
      return {
        player,
        mode: isNameToTeam ? "name_to_teampos" : "teampos_to_name"
      };
    });
  }

  function renderProgress() {
    progressEl.innerHTML = "";
    for (let i = 0; i < TOTAL_QUESTIONS; i++) {
      const dot = document.createElement("div");
      dot.className = "progress-dot";
      dot.textContent = i + 1;
      if (i < results.length) {
        dot.classList.add(results[i] ? "correct" : "wrong");
      } else if (i === currentIndex) {
        dot.classList.add("current");
      }
      progressEl.appendChild(dot);
    }
  }

  function showQuestion() {
    if (currentIndex >= TOTAL_QUESTIONS) {
      showResults();
      return;
    }

    const q = gameQuestions[currentIndex];
    questionLabel.textContent = `Question ${currentIndex + 1} of ${TOTAL_QUESTIONS}`;

    feedbackCard.className = "feedback-card";
    inputName.value = "";
    inputTeam.value = "";
    inputPos.value = "";
    awaitingNext = false;
    btnSubmit.textContent = "Submit";

    if (q.mode === "name_to_teampos") {
      questionMain.textContent = q.player.name;
      questionSub.textContent = "What team and position?";
      fieldName.style.display = "none";
      fieldTeam.style.display = "block";
      fieldPos.style.display = "block";
      inputTeam.focus();
    } else {
      questionMain.textContent = q.player.team + " ‚Äî " + displayPosition(q.player.position);
      questionSub.textContent = "Who is this player?";
      fieldName.style.display = "block";
      fieldTeam.style.display = "none";
      fieldPos.style.display = "none";
      inputName.focus();
    }

    renderProgress();
  }

  function getValidNamesForTeamPos(team, position) {
    const teamNorm = normalizeString(team);
    const posNorm = canonicalizePosition(position);
    return players
      .filter(p => normalizeString(p.team) === teamNorm &&
                   canonicalizePosition(p.position) === posNorm)
      .map(p => normalizeString(p.name));
  }

  function checkAnswer() {
    const q = gameQuestions[currentIndex];
    let isCorrect = false;

    if (q.mode === "name_to_teampos") {
      const teamGuess = normalizeString(inputTeam.value);
      const posGuess = canonicalizePosition(inputPos.value);
      const teamTrue = normalizeString(q.player.team);
      const posTrue = canonicalizePosition(q.player.position);
      isCorrect = teamGuess && posGuess && fuzzyMatch(teamGuess, teamTrue) && (posGuess === posTrue);
    } else {
      const nameGuess = normalizeString(inputName.value);
      const validNames = getValidNamesForTeamPos(q.player.team, q.player.position);
      isCorrect = nameGuess && validNames.some(n => fuzzyMatch(nameGuess, n));
    }

    results.push(isCorrect);

    feedbackCard.className = "feedback-card visible " + (isCorrect ? "correct" : "incorrect");
    feedbackTitle.textContent = isCorrect ? "Correct!" : "Wrong";
    feedbackAnswer.textContent = q.player.name + " ¬∑ " + q.player.team + " ¬∑ " + displayPosition(q.player.position);

    renderProgress();
    awaitingNext = true;
    btnSubmit.textContent = currentIndex < TOTAL_QUESTIONS - 1 ? "Next" : "See Results";
    document.activeElement.blur();
  }

  function showResults() {
    gameArea.style.display = "none";
    resultsEl.classList.add("visible");

    saveDailyResults();

    const correct = results.filter(r => r).length;
    resultsScore.textContent = `${correct}/${TOTAL_QUESTIONS}`;

    const emoji = results.map(r => r ? "üü©" : "üü•").join("");
    resultsEmoji.textContent = emoji;

    const today = new Date();
    const dateStr = today.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
    const diffName = DIFFICULTY_NAMES[String(topN)] || `Top ${topN}`;

    const shareText = `NFL Roster Quiz ${dateStr}\n${diffName} Mode: ${correct}/${TOTAL_QUESTIONS}\n${emoji}`;
    shareBox.textContent = shareText;
  }

  btnSubmit.addEventListener("click", () => {
    if (awaitingNext) {
      currentIndex++;
      showQuestion();
    } else {
      checkAnswer();
    }
  });

  btnCopy.addEventListener("click", () => {
    navigator.clipboard.writeText(shareBox.textContent).then(() => {
      copiedEl.style.display = "block";
      setTimeout(() => { copiedEl.style.display = "none"; }, 2000);
    });
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      if (awaitingNext) {
        currentIndex++;
        showQuestion();
      } else {
        checkAnswer();
      }
    }
    if (e.target.tagName === "INPUT") return;
    if (e.key === "ArrowRight" || e.key === "ArrowDown") {
      e.preventDefault();
      if (awaitingNext) {
        currentIndex++;
        showQuestion();
      } else {
        checkAnswer();
      }
    }
  });

  function getPlayerSnaps(p) {
    const stats = p.stats || {};
    return (stats.off_snp || 0) + (stats.def_snp || 0);
  }

  function filterPlayers() {
    players = allPlayers.slice(0, topN);
  }

  function setDifficulty(val) {
    topN = parseInt(val, 10) || 200;
    difficultySelect.value = val;
    filterPlayers();
    try { localStorage.setItem(STORAGE_KEY_DIFF, val); } catch(e) {}
    if (allPlayers.length > 0) {
      currentIndex = 0;
      results = [];
      generateDailyQuestions();
      const savedResults = loadDailyResults();
      if (savedResults) {
        results = savedResults;
        showResults();
      } else {
        showQuestion();
        gameArea.style.display = "block";
        resultsEl.classList.remove("visible");
      }
    }
  }

  async function loadPlayers() {
    try {
      try {
        const diff = localStorage.getItem(STORAGE_KEY_DIFF);
        if (diff) {
          topN = parseInt(diff, 10) || 200;
          difficultySelect.value = diff;
        }
      } catch(e) {}

      const resp = await fetch(DEFAULT_JSON_URL, { cache: "no-store" });
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const parsed = await resp.json();
      if (!Array.isArray(parsed)) throw new Error("JSON must be an array");

      allPlayers = parsed
        .map(p => ({
          name: String(p.name || ((p.first_name || "") + " " + (p.last_name || ""))).trim(),
          team: String(p.team || p.team_name || "").trim(),
          position: String(p.position || p.position_abbreviation || "").trim(),
          stats: p.stats || {}
        }))
        .filter(p => p.name && p.team && p.position)
        .sort((a, b) => getPlayerSnaps(b) - getPlayerSnaps(a));

      filterPlayers();

      if (players.length < TOTAL_QUESTIONS) {
        throw new Error("Not enough players in roster");
      }

      generateDailyQuestions();

      const savedResults = loadDailyResults();
      if (savedResults) {
        results = savedResults;
        showResults();
      } else {
        showQuestion();
      }
    } catch (err) {
      questionMain.textContent = "Could not load players";
      questionSub.textContent = err.message;
    }
  }

  difficultySelect.addEventListener("change", (e) => setDifficulty(e.target.value));

  document.addEventListener("DOMContentLoaded", () => {
    loadPlayers();
  });
</script>
</body>
</html>
