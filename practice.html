<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NFL Roster Quiz - Practice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèà</text></svg>" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-deep: #030712;
      --bg-card: #0f172a;
      --bg-elevated: #1e293b;
      --accent: #3b82f6;
      --accent-glow: rgba(59, 130, 246, 0.4);
      --accent-subtle: rgba(59, 130, 246, 0.15);
      --success: #22c55e;
      --error: #ef4444;
      --warning: #0ea5e9;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-subtle: rgba(148, 163, 184, 0.15);
      --border-accent: rgba(59, 130, 246, 0.5);
    }

    body {
      font-family: 'Source Sans 3', system-ui, sans-serif;
      background: var(--bg-deep);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Subtle background atmosphere */
    .bg-layer {
      position: fixed;
      inset: 0;
      z-index: -1;
      background:
        radial-gradient(ellipse 80% 60% at 50% 0%, rgba(59, 130, 246, 0.08), transparent 50%),
        radial-gradient(ellipse 60% 40% at 100% 100%, rgba(59, 130, 246, 0.05), transparent),
        var(--bg-deep);
    }

    .container {
      max-width: 540px;
      margin: 0 auto;
      padding: 2rem 1.25rem 3rem;
    }

    /* Header */
    header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    h1 {
      font-family: 'Oswald', sans-serif;
      font-size: 1.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 0.25rem;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    /* Stats bar */
    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      padding: 0.875rem 1rem;
      background: var(--bg-card);
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      margin-bottom: 1rem;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-family: 'Oswald', sans-serif;
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--accent);
    }

    .stat-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    /* Settings toggle */
    .settings-toggle {
      display: flex;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .gear-btn {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      background: transparent;
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 0.8rem;
      padding: 0.4rem 0.75rem;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .gear-btn:hover {
      color: var(--text-primary);
      border-color: var(--accent);
    }

    .gear-btn svg {
      width: 14px;
      height: 14px;
    }

    /* Settings panel */
    .settings {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out, margin 0.3s ease-out;
      margin-bottom: 0;
    }

    .settings.open {
      max-height: 280px;
      margin-bottom: 1rem;
    }

    .settings-inner {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: 10px;
      padding: 1rem;
    }

    .settings-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.875rem;
    }

    .settings-row:last-child {
      margin-bottom: 0;
    }

    .settings label {
      font-size: 0.8rem;
      color: var(--text-secondary);
      min-width: 70px;
    }

    .settings select, .settings input[type="file"] {
      background: var(--bg-deep);
      border-radius: 6px;
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      padding: 0.5rem 0.75rem;
      font-family: inherit;
      font-size: 0.85rem;
      flex: 1;
    }

    .settings select:focus {
      outline: none;
      border-color: var(--accent);
    }

    button.danger {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.3);
      padding: 0.4rem 0.75rem;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    button.danger:hover {
      background: rgba(239, 68, 68, 0.25);
      border-color: rgba(239, 68, 68, 0.5);
    }

    /* Question card */
    .question-card {
      position: relative;
      padding: 1.5rem;
      border-radius: 14px;
      background: linear-gradient(145deg, rgba(59, 130, 246, 0.12), var(--bg-card) 40%);
      border: 1px solid var(--border-accent);
      box-shadow:
        0 4px 20px rgba(0, 0, 0, 0.3),
        0 0 40px var(--accent-subtle);
    }

    .question-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), transparent);
      border-radius: 14px 14px 0 0;
    }

    .question-main {
      font-family: 'Oswald', sans-serif;
      font-size: 1.75rem;
      font-weight: 500;
      text-align: center;
      margin-bottom: 1.25rem;
      letter-spacing: 0.01em;
    }

    .answer-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .field {
      flex: 1 1 140px;
    }

    .field label {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-bottom: 0.35rem;
    }

    input[type="text"] {
      width: 100%;
      background: var(--bg-deep);
      border-radius: 8px;
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      padding: 0.7rem 1rem;
      font-family: inherit;
      font-size: 1rem;
      transition: all 0.2s ease;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-subtle);
    }

    button.primary {
      width: 100%;
      border-radius: 8px;
      padding: 0.85rem 1rem;
      border: none;
      cursor: pointer;
      font-family: 'Oswald', sans-serif;
      font-size: 1rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: linear-gradient(135deg, var(--accent), #2563eb);
      color: white;
      box-shadow: 0 4px 15px var(--accent-glow);
      transition: all 0.2s ease;
    }

    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px var(--accent-glow);
    }

    button.primary:active {
      transform: translateY(0);
    }

    /* Feedback */
    .feedback {
      margin-top: 1rem;
      padding: 0.875rem 1rem;
      border-radius: 10px;
      font-size: 0.95rem;
      display: none;
      border-left: 3px solid;
    }

    .feedback.visible { display: block; }

    .feedback.correct {
      background: rgba(34, 197, 94, 0.12);
      border-left-color: var(--success);
      color: #bbf7d0;
    }

    .feedback.incorrect {
      background: rgba(239, 68, 68, 0.12);
      border-left-color: var(--error);
      color: #fecaca;
    }

    .feedback.partial {
      background: rgba(14, 165, 233, 0.12);
      border-left-color: var(--warning);
      color: #7dd3fc;
    }

    .feedback-title {
      font-family: 'Oswald', sans-serif;
      font-weight: 500;
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .feedback-answer {
      margin-top: 0.25rem;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    /* Footer */
    .footer {
      margin-top: 2rem;
      padding-top: 1.25rem;
      border-top: 1px solid var(--border-subtle);
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .footer a {
      color: var(--text-secondary);
      text-decoration: none;
      transition: color 0.2s ease;
    }

    .footer a:hover {
      color: var(--accent);
    }

    @media (max-width: 400px) {
      .container { padding: 1.5rem 1rem 2rem; }
      .question-main { font-size: 1.5rem; }
      .stats-bar { gap: 1rem; }
    }
  </style>
</head>
<body>
<div class="bg-layer"></div>

<div class="container">
  <header>
    <h1>Practice Mode</h1>
    <p class="subtitle">Learn with spaced repetition</p>
  </header>

  <div class="stats-bar">
    <div class="stat-item">
      <div class="stat-value" id="seen-count">0</div>
      <div class="stat-label">Seen</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="correct-count">0</div>
      <div class="stat-label">Correct</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="accuracy">0%</div>
      <div class="stat-label">Accuracy</div>
    </div>
  </div>

  <div class="settings-toggle">
    <button class="gear-btn" id="gear-btn">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
      </svg>
      Settings
    </button>
  </div>

  <div class="settings" id="settings">
    <div class="settings-inner">
      <div class="settings-row">
        <label for="mode">Mode:</label>
        <select id="mode">
          <option value="name_to_teampos">Name ‚Üí Team & Position</option>
          <option value="teampos_to_name">Team & Position ‚Üí Name</option>
          <option value="mixed">Mixed (random)</option>
        </select>
      </div>
      <div class="settings-row">
        <label for="difficulty">Difficulty:</label>
        <select id="difficulty">
          <option value="50">Casual (Top 50)</option>
          <option value="100">Easy (Top 100)</option>
          <option value="200" selected>Medium (Top 200)</option>
          <option value="350">Hard (Top 350)</option>
          <option value="500">Diehard (Top 500)</option>
          <option value="750">Insane (Top 750)</option>
        </select>
      </div>
      <div class="settings-row">
        <label for="file-input">Custom:</label>
        <input id="file-input" type="file" accept=".json" />
      </div>
      <div class="settings-row">
        <button class="danger" id="btn-reset">Reset Stats</button>
      </div>
    </div>
  </div>

  <div class="question-card">
    <div class="question-main" id="question-main">Loading...</div>

    <div class="answer-row">
      <div class="field" id="field-name" style="display:none;">
        <label for="input-name">Player Name</label>
        <input id="input-name" type="text" placeholder="e.g. Patrick Mahomes" autocomplete="off" />
      </div>
      <div class="field" id="field-team" style="display:none;">
        <label for="input-team">Team</label>
        <input id="input-team" type="text" placeholder="e.g. Chiefs" autocomplete="off" />
      </div>
      <div class="field" id="field-pos" style="display:none;">
        <label for="input-pos">Position</label>
        <input id="input-pos" type="text" placeholder="e.g. QB" autocomplete="off" />
      </div>
    </div>

    <button class="primary" id="btn-main">Check</button>

    <div class="feedback" id="feedback">
      <div class="feedback-title" id="feedback-title"></div>
      <div class="feedback-answer" id="feedback-answer"></div>
    </div>
  </div>

  <div class="footer">
    <a href="index.html">Home</a> ¬∑ <a href="easy.html">Multiple Choice</a> ¬∑ <a href="game.html">Daily</a> ¬∑ <a href="trivia.html">Trivia</a> ¬∑ <a href="team-study.html">Depth Charts</a> ¬∑ <a href="stats-quiz.html">Stats Quiz</a> ¬∑ <a href="explorer.html">SQL Explorer</a>
  </div>
</div>

<script>
  const POSITION_MAP = {
    QB: "Quarterback", RB: "Running Back", FB: "Fullback", WR: "Wide Receiver",
    TE: "Tight End", OL: "Offensive Lineman", OT: "Offensive Tackle", OG: "Offensive Guard", C: "Center",
    G: "Guard", T: "Tackle", DL: "Defensive Lineman", DE: "Defensive End",
    DT: "Defensive Tackle", NT: "Nose Tackle", EDGE: "Edge Rusher", LB: "Linebacker",
    OLB: "Outside Linebacker", ILB: "Inside Linebacker", MLB: "Middle Linebacker",
    DB: "Defensive Back", CB: "Cornerback", S: "Safety", FS: "Free Safety",
    SS: "Strong Safety", K: "Kicker", P: "Punter", LS: "Long Snapper"
  };

  const POS_CANON = {
    qb: "QB", quarterback: "QB", rb: "RB", runningback: "RB", fb: "FB", fullback: "FB",
    wr: "WR", widereceiver: "WR", receiver: "WR", te: "TE", tightend: "TE",
    ol: "OL", offensivelineman: "OL", ot: "OT", offensivetackle: "OT", og: "OG", offensiveguard: "OG", c: "C", center: "C",
    g: "G", guard: "G", t: "T", tackle: "T", dl: "DL", defensivelineman: "DL",
    de: "DE", defensiveend: "DE", dt: "DT", defensivetackle: "DT", nt: "NT", nosetackle: "NT",
    edge: "EDGE", edgerusher: "EDGE", lb: "LB", linebacker: "LB",
    olb: "OLB", outsidelinebacker: "OLB", ilb: "ILB", insidelinebacker: "ILB",
    mlb: "MLB", middlelinebacker: "MLB", db: "DB", defensiveback: "DB",
    cb: "CB", cornerback: "CB", s: "S", safety: "S", fs: "FS", freesafety: "FS",
    ss: "SS", strongsafety: "SS", k: "K", kicker: "K", p: "P", punter: "P",
    ls: "LS", longsnapper: "LS"
  };

  const STORAGE_KEY_STATS = "nflQuizStats_v1";
  const STORAGE_KEY_GLOBAL = "nflQuizGlobal_v1";
  const STORAGE_KEY_MODE = "nflQuizMode_v1";
  const STORAGE_KEY_DIFF = "nflQuizDiff_v1";

  let allPlayers = [];
  let players = [];
  let topN = 200;
  let stats = {};
  let globalStats = { seen: 0, correct: 0 };
  let currentCard = null;
  let currentQuestionMode = "name_to_teampos";
  let awaitingAnswer = true;

  const gearBtn = document.getElementById("gear-btn");
  const settingsEl = document.getElementById("settings");
  const modeSelect = document.getElementById("mode");
  const fileInput = document.getElementById("file-input");
  const seenEl = document.getElementById("seen-count");
  const correctEl = document.getElementById("correct-count");
  const accuracyEl = document.getElementById("accuracy");
  const questionMain = document.getElementById("question-main");
  const fieldName = document.getElementById("field-name");
  const fieldTeam = document.getElementById("field-team");
  const fieldPos = document.getElementById("field-pos");
  const inputName = document.getElementById("input-name");
  const inputTeam = document.getElementById("input-team");
  const inputPos = document.getElementById("input-pos");
  const btnMain = document.getElementById("btn-main");
  const btnReset = document.getElementById("btn-reset");
  const feedbackEl = document.getElementById("feedback");
  const feedbackTitle = document.getElementById("feedback-title");
  const feedbackAnswer = document.getElementById("feedback-answer");
  const difficultySelect = document.getElementById("difficulty");

  function normalizeString(str) {
    return String(str || "").trim().toLowerCase().replace(/\s+/g, "");
  }

  function levenshtein(a, b) {
    const m = a.length, n = b.length;
    const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;
    for (let i = 1; i <= m; i++) {
      for (let j = 1; j <= n; j++) {
        if (a[i-1] === b[j-1]) dp[i][j] = dp[i-1][j-1];
        else dp[i][j] = 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
      }
    }
    return dp[m][n];
  }

  function fuzzyMatch(guess, correct) {
    if (!guess || !correct) return false;
    if (guess === correct) return true;
    if (correct.endsWith(guess) && guess.length >= 5) return true;
    const len = correct.length;
    if (len <= 3) return false;
    const dist = levenshtein(guess, correct);
    const maxDist = len <= 6 ? 1 : 2;
    return dist <= maxDist;
  }

  function getPlayerSnaps(p) {
    const s = p.stats || {};
    return (s.off_snp || 0) + (s.def_snp || 0);
  }

  function filterPlayers() {
    players = allPlayers.slice(0, topN);
  }

  function setDifficulty(val) {
    topN = parseInt(val, 10) || 200;
    difficultySelect.value = val;
    filterPlayers();
    try { localStorage.setItem(STORAGE_KEY_DIFF, val); } catch(e) {}
  }

  function canonicalizePosition(input) {
    const trimmed = normalizeString(input);
    if (!trimmed) return "";
    if (POS_CANON[trimmed]) return POS_CANON[trimmed];
    const abbr = input.toUpperCase().replace(/[^A-Z]/g, "");
    if (POSITION_MAP[abbr]) return abbr;
    return abbr;
  }

  function displayPosition(abbr) {
    const key = String(abbr || "").toUpperCase();
    return POSITION_MAP[key] ? key + " ‚Äî " + POSITION_MAP[key] : key;
  }

  function loadStats() {
    try {
      const s = localStorage.getItem(STORAGE_KEY_STATS);
      if (s) stats = JSON.parse(s);
      const g = localStorage.getItem(STORAGE_KEY_GLOBAL);
      if (g) globalStats = JSON.parse(g);
      const m = localStorage.getItem(STORAGE_KEY_MODE);
      if (m) modeSelect.value = m;
      const diff = localStorage.getItem(STORAGE_KEY_DIFF);
      if (diff) {
        topN = parseInt(diff, 10) || 200;
        difficultySelect.value = diff;
      }
    } catch (e) {}
    updateStatsUI();
  }

  function saveStats() {
    try {
      localStorage.setItem(STORAGE_KEY_STATS, JSON.stringify(stats));
      localStorage.setItem(STORAGE_KEY_GLOBAL, JSON.stringify(globalStats));
      localStorage.setItem(STORAGE_KEY_MODE, modeSelect.value);
    } catch (e) {}
  }

  function cardKey(card) {
    return ((card.name || "") + "|" + (card.team || "") + "|" + (card.position || "")).toLowerCase();
  }

  function updateStatsUI() {
    seenEl.textContent = globalStats.seen;
    correctEl.textContent = Number.isInteger(globalStats.correct) ? globalStats.correct : globalStats.correct.toFixed(1);
    const acc = globalStats.seen > 0 ? Math.round((globalStats.correct / globalStats.seen) * 100) : 0;
    accuracyEl.textContent = acc + "%";
  }

  function pickNextCard() {
    if (!players.length) return null;
    const now = Date.now();
    let best = null, bestScore = Infinity;
    for (const p of players) {
      const s = stats[cardKey(p)] || { correct: 0, wrong: 0, lastSeen: 0 };
      const mastery = s.correct - s.wrong;
      const daysSince = s.lastSeen ? (now - s.lastSeen) / 86400000 : 999;
      const score = mastery - daysSince + Math.random() * 0.5;
      if (score < bestScore) { bestScore = score; best = p; }
    }
    return best;
  }

  function setModeFields() {
    inputName.value = ""; inputTeam.value = ""; inputPos.value = "";
    if (currentQuestionMode === "name_to_teampos") {
      fieldName.style.display = "none";
      fieldTeam.style.display = "block";
      fieldPos.style.display = "block";
    } else {
      fieldName.style.display = "block";
      fieldTeam.style.display = "none";
      fieldPos.style.display = "none";
    }
  }

  function resolveMode() {
    const mode = modeSelect.value;
    if (mode === "mixed") {
      return Math.random() < 0.5 ? "name_to_teampos" : "teampos_to_name";
    }
    return mode;
  }

  function showQuestion(card) {
    if (!card) {
      questionMain.textContent = "No players loaded";
      return;
    }
    if (currentQuestionMode === "name_to_teampos") {
      questionMain.textContent = card.name;
    } else {
      questionMain.textContent = card.team + " ‚Äî " + displayPosition(card.position);
    }
  }

  function updateStatForCard(card, isCorrect, isPartial = false) {
    if (!card) return;
    const key = cardKey(card);
    if (!stats[key]) stats[key] = { correct: 0, wrong: 0, lastSeen: 0 };
    if (isCorrect) {
      stats[key].correct++;
      globalStats.correct++;
    } else if (isPartial) {
      stats[key].correct += 0.5;
      stats[key].wrong += 0.5;
      globalStats.correct += 0.5;
    } else {
      stats[key].wrong++;
    }
    stats[key].lastSeen = Date.now();
    globalStats.seen++;
    saveStats();
    updateStatsUI();
  }

  function getValidNamesForTeamPos(team, position) {
    const teamNorm = normalizeString(team);
    const posNorm = canonicalizePosition(position);
    return players
      .filter(p => normalizeString(p.team) === teamNorm &&
                   canonicalizePosition(p.position) === posNorm)
      .map(p => normalizeString(p.name));
  }

  function checkAnswer() {
    if (!currentCard) return;
    let result = "incorrect";

    if (currentQuestionMode === "name_to_teampos") {
      const teamGuess = normalizeString(inputTeam.value);
      const posGuess = canonicalizePosition(inputPos.value);
      const teamCorrect = teamGuess && fuzzyMatch(teamGuess, normalizeString(currentCard.team));
      const posCorrect = posGuess && posGuess === canonicalizePosition(currentCard.position);

      if (teamCorrect && posCorrect) result = "correct";
      else if (teamCorrect || posCorrect) result = "partial";
    } else {
      const nameGuess = normalizeString(inputName.value);
      const validNames = getValidNamesForTeamPos(currentCard.team, currentCard.position);
      if (nameGuess && validNames.some(n => fuzzyMatch(nameGuess, n))) result = "correct";
    }

    feedbackEl.className = "feedback visible " + result;
    if (result === "correct") feedbackTitle.textContent = "Correct!";
    else if (result === "partial") feedbackTitle.textContent = "Half Right";
    else feedbackTitle.textContent = "Wrong";

    feedbackAnswer.textContent = currentCard.name + " ¬∑ " + currentCard.team + " ¬∑ " + displayPosition(currentCard.position);
    updateStatForCard(currentCard, result === "correct", result === "partial");
  }

  function nextQuestion() {
    feedbackEl.className = "feedback";
    awaitingAnswer = true;
    btnMain.textContent = "Check";
    currentCard = pickNextCard();
    currentQuestionMode = resolveMode();
    setModeFields();
    showQuestion(currentCard);
    if (currentQuestionMode === "name_to_teampos") inputTeam.focus();
    else inputName.focus();
  }

  function handleMain() {
    if (!currentCard && players.length) { nextQuestion(); return; }
    if (awaitingAnswer) {
      checkAnswer();
      awaitingAnswer = false;
      btnMain.textContent = "Next";
      document.activeElement.blur();
    } else {
      nextQuestion();
    }
  }

  async function loadPlayers() {
    try {
      const resp = await fetch("players-with-stats-2025.json", { cache: "no-store" });
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const parsed = await resp.json();
      allPlayers = parsed
        .map(p => ({
          name: String(p.name || ((p.first_name || "") + " " + (p.last_name || ""))).trim(),
          team: String(p.team || "").trim(),
          position: String(p.position || "").trim(),
          stats: p.stats || {}
        }))
        .filter(p => p.name && p.team && p.position)
        .sort((a, b) => getPlayerSnaps(b) - getPlayerSnaps(a));
      filterPlayers();
      if (players.length) nextQuestion();
      else questionMain.textContent = "No players found";
    } catch (err) {
      questionMain.textContent = "Could not load players";
    }
  }

  // Events
  gearBtn.addEventListener("click", () => settingsEl.classList.toggle("open"));

  modeSelect.addEventListener("change", () => {
    currentQuestionMode = resolveMode();
    setModeFields();
    showQuestion(currentCard);
    saveStats();
  });

  btnMain.addEventListener("click", handleMain);

  btnReset.addEventListener("click", () => {
    if (!confirm("Reset all stats?")) return;
    stats = {}; globalStats = { seen: 0, correct: 0 };
    saveStats(); updateStatsUI();
  });

  difficultySelect.addEventListener("change", (e) => setDifficulty(e.target.value));

  fileInput.addEventListener("change", (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (evt) => {
      try {
        const parsed = JSON.parse(evt.target.result);
        players = parsed
          .map(p => ({
            name: String(p.name || ((p.first_name || "") + " " + (p.last_name || ""))).trim(),
            team: String(p.team || "").trim(),
            position: String(p.position || "").trim()
          }))
          .filter(p => p.name && p.team && p.position);
        if (players.length) nextQuestion();
      } catch (err) { alert("Could not parse JSON"); }
    };
    reader.readAsText(file);
  });

  document.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      handleMain();
      return;
    }
    if ((e.key === "ArrowRight" || e.key === "ArrowDown") &&
        (e.target.tagName !== "INPUT" || !awaitingAnswer)) {
      e.preventDefault();
      handleMain();
    }
  });

  // Init
  loadStats();
  currentQuestionMode = resolveMode();
  setModeFields();
  loadPlayers();
</script>
</body>
</html>
