<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NFL Lineup Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'></text></svg>" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-deep: #030712;
      --bg-card: #0c1322;
      --field-green: #2d5a27;
      --field-line: rgba(255, 255, 255, 0.3);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-offense: #3b82f6;
      --accent-defense: #dc2626;
    }

    body {
      font-family: 'Source Sans 3', system-ui, sans-serif;
      background: var(--bg-deep);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 1.5rem 1rem 2rem;
    }

    header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    h1 {
      font-family: 'Oswald', sans-serif;
      font-size: 1.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      margin-bottom: 0.25rem;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 1.25rem;
      flex-wrap: wrap;
    }

    .controls select {
      background: var(--bg-card);
      border: 1px solid #374151;
      border-radius: 6px;
      color: var(--text-primary);
      padding: 0.5rem 0.75rem;
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .controls select:focus {
      outline: none;
      border-color: var(--accent-offense);
    }

    .vs-label {
      font-family: 'Oswald', sans-serif;
      font-weight: 600;
      color: var(--text-muted);
      padding: 0 0.5rem;
    }

    .status {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 1rem;
    }
    .status.loading { color: #fbbf24; }
    .status.ready { color: #22c55e; }
    .status.error { color: #dc2626; }

    /* Field container */
    .field-container {
      background: var(--field-green);
      border-radius: 12px;
      padding: 1.5rem 1rem;
      position: relative;
      overflow: hidden;
    }

    /* Yard line decorations */
    .field-container::before {
      content: '';
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        to bottom,
        transparent,
        transparent 48px,
        var(--field-line) 48px,
        var(--field-line) 50px
      );
      pointer-events: none;
    }

    /* Section headers */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      margin-bottom: 1rem;
      font-family: 'Oswald', sans-serif;
      font-size: 0.85rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      border-radius: 6px;
    }

    .section-header.offense {
      background: rgba(59, 130, 246, 0.2);
      color: var(--accent-offense);
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .section-header.defense {
      background: rgba(220, 38, 38, 0.2);
      color: var(--accent-defense);
      border: 1px solid rgba(220, 38, 38, 0.3);
    }

    /* Line of scrimmage */
    .line-of-scrimmage {
      height: 4px;
      background: linear-gradient(90deg, transparent, #fff, transparent);
      margin: 1.5rem 0;
      position: relative;
    }

    .line-of-scrimmage::after {
      content: 'LINE OF SCRIMMAGE';
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      background: var(--field-green);
      padding: 0 1rem;
      font-family: 'Oswald', sans-serif;
      font-size: 0.65rem;
      font-weight: 500;
      letter-spacing: 0.15em;
      color: rgba(255, 255, 255, 0.6);
    }

    /* Formation layouts */
    .formation {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      align-items: center;
    }

    .formation-row {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .formation-row.wide {
      gap: 2rem;
    }

    .formation-row.spread {
      width: 100%;
      justify-content: space-between;
      padding: 0 1rem;
    }

    /* Player card */
    .player-card {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.5rem 0.75rem;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 8px;
      min-width: 70px;
      transition: transform 0.15s ease, background 0.15s ease;
      cursor: default;
    }

    .player-card:hover {
      transform: scale(1.05);
      background: rgba(0, 0, 0, 0.7);
    }

    .player-card.offense {
      border: 2px solid var(--accent-offense);
    }

    .player-card.defense {
      border: 2px solid var(--accent-defense);
    }

    .player-number {
      font-family: 'Oswald', sans-serif;
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1;
    }

    .player-card.offense .player-number {
      color: var(--accent-offense);
    }

    .player-card.defense .player-number {
      color: var(--accent-defense);
    }

    .player-name {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      max-width: 80px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      text-align: center;
    }

    .player-position {
      font-size: 0.6rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* Team labels */
    .team-label {
      text-align: center;
      font-family: 'Oswald', sans-serif;
      font-size: 1rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
      opacity: 0.8;
    }

    .no-data {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .no-data-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      opacity: 0.5;
    }

    .footer {
      margin-top: 2rem;
      padding-top: 1.25rem;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .footer a {
      color: var(--text-secondary);
      text-decoration: none;
      transition: color 0.15s ease;
    }

    .footer a:hover {
      color: var(--text-primary);
    }

    @media (max-width: 600px) {
      .player-card {
        min-width: 55px;
        padding: 0.4rem 0.5rem;
      }
      .player-number { font-size: 1.2rem; }
      .player-name { font-size: 0.6rem; max-width: 60px; }
      .formation-row.spread { padding: 0; }
      .formation-row.wide { gap: 1rem; }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Lineup Viewer</h1>
    <p class="subtitle">Visual team formations with starters</p>
  </header>

  <div class="controls">
    <select id="year-select">
      <option value="">Loading...</option>
    </select>
    <select id="offense-team">
      <option value="">Offense...</option>
    </select>
    <span class="vs-label">vs</span>
    <select id="defense-team">
      <option value="">Defense...</option>
    </select>
  </div>

  <div class="status loading" id="status">Loading database...</div>

  <div id="field-content">
    <div class="no-data">
      <div class="no-data-icon"></div>
      <div>Select two teams to view matchup</div>
    </div>
  </div>

  <div class="footer">
    <a href="index.html">Home</a> 路 <a href="practice.html">Practice</a> 路 <a href="easy.html">Multiple Choice</a> 路 <a href="game.html">Daily</a> 路 <a href="trivia.html">Trivia</a> 路 <a href="stats-quiz.html">Stats Quiz</a> 路 <a href="team-study.html">Depth Charts</a> 路 <a href="position-leaders.html">Position Leaders</a> 路 <a href="explorer.html">SQL Explorer</a>
  </div>
</div>

<script>
  const STORAGE_KEY_YEAR = "nflLineup_year_v1";
  const STORAGE_KEY_OFF = "nflLineup_offense_v1";
  const STORAGE_KEY_DEF = "nflLineup_defense_v1";

  let db = null;
  let selectedYear = 2025;

  // Position groupings
  const OFFENSE = {
    QB: { positions: ['QB'], count: 1 },
    RB: { positions: ['RB', 'FB'], count: 1 },
    WR: { positions: ['WR'], count: 3 },
    TE: { positions: ['TE'], count: 1 },
    OL: { positions: ['OL', 'OT', 'G', 'C', 'T'], count: 5 },
  };

  const DEFENSE = {
    DL: { positions: ['DL', 'DE', 'DT', 'NT'], count: 4 },
    LB: { positions: ['LB', 'OLB', 'ILB', 'MLB', 'EDGE'], count: 3 },
    CB: { positions: ['CB'], count: 2 },
    S: { positions: ['S', 'SS', 'FS', 'DB'], count: 2 },
  };

  const statusEl = document.getElementById("status");
  const yearSelect = document.getElementById("year-select");
  const offenseTeamSelect = document.getElementById("offense-team");
  const defenseTeamSelect = document.getElementById("defense-team");
  const fieldContent = document.getElementById("field-content");

  function runQueryFullParams(sql, params = []) {
    try {
      const stmt = db.prepare(sql);
      if (params.length) stmt.bind(params);
      const results = [];
      const cols = stmt.getColumnNames();
      while (stmt.step()) {
        const row = stmt.get();
        const obj = {};
        cols.forEach((c, i) => obj[c] = row[i]);
        results.push(obj);
      }
      stmt.free();
      return results;
    } catch (e) {
      console.error("SQL error:", e, sql, params);
      return [];
    }
  }

  function getStarters(team, positionGroup, count) {
    const placeholders = positionGroup.positions.map(() => '?').join(', ');
    const players = runQueryFullParams(`
      SELECT name, position, number, gs, off_snp, def_snp
      FROM players
      WHERE year = ? AND team = ? AND position IN (${placeholders})
      ORDER BY COALESCE(gs, 0) DESC, (COALESCE(off_snp, 0) + COALESCE(def_snp, 0)) DESC
      LIMIT ?
    `, [selectedYear, team, ...positionGroup.positions, count]);
    return players;
  }

  function getLastName(fullName) {
    const parts = fullName.split(' ');
    return parts.length > 1 ? parts[parts.length - 1] : fullName;
  }

  function renderPlayerCard(player, side) {
    const number = player.number || '?';
    const lastName = getLastName(player.name);
    return `
      <div class="player-card ${side}">
        <div class="player-number">${number}</div>
        <div class="player-name" title="${player.name}">${lastName}</div>
        <div class="player-position">${player.position}</div>
      </div>
    `;
  }

  function renderFormation() {
    const offenseTeam = offenseTeamSelect.value;
    const defenseTeam = defenseTeamSelect.value;

    if (!offenseTeam || !defenseTeam) {
      fieldContent.innerHTML = `
        <div class="no-data">
          <div class="no-data-icon"></div>
          <div>Select two teams to view matchup</div>
        </div>
      `;
      return;
    }

    // Get offensive starters
    const qb = getStarters(offenseTeam, OFFENSE.QB, 1);
    const rb = getStarters(offenseTeam, OFFENSE.RB, 1);
    const wr = getStarters(offenseTeam, OFFENSE.WR, 3);
    const te = getStarters(offenseTeam, OFFENSE.TE, 1);
    const ol = getStarters(offenseTeam, OFFENSE.OL, 5);

    // Get defensive starters
    const dl = getStarters(defenseTeam, DEFENSE.DL, 4);
    const lb = getStarters(defenseTeam, DEFENSE.LB, 3);
    const cb = getStarters(defenseTeam, DEFENSE.CB, 2);
    const s = getStarters(defenseTeam, DEFENSE.S, 2);

    // Build offense HTML
    const offenseHtml = `
      <div class="team-label">${offenseTeam} Offense</div>
      <div class="section-header offense">Offense</div>
      <div class="formation">
        <div class="formation-row spread">
          ${wr.slice(0, 1).map(p => renderPlayerCard(p, 'offense')).join('')}
          <div></div>
          ${wr.slice(1, 2).map(p => renderPlayerCard(p, 'offense')).join('')}
        </div>
        <div class="formation-row">
          ${qb.map(p => renderPlayerCard(p, 'offense')).join('')}
        </div>
        <div class="formation-row">
          ${ol.map(p => renderPlayerCard(p, 'offense')).join('')}
        </div>
        <div class="formation-row wide">
          ${te.map(p => renderPlayerCard(p, 'offense')).join('')}
          ${rb.map(p => renderPlayerCard(p, 'offense')).join('')}
          ${wr.slice(2, 3).map(p => renderPlayerCard(p, 'offense')).join('')}
        </div>
      </div>
    `;

    // Build defense HTML
    const defenseHtml = `
      <div class="team-label">${defenseTeam} Defense</div>
      <div class="section-header defense">Defense</div>
      <div class="formation">
        <div class="formation-row">
          ${dl.map(p => renderPlayerCard(p, 'defense')).join('')}
        </div>
        <div class="formation-row">
          ${lb.map(p => renderPlayerCard(p, 'defense')).join('')}
        </div>
        <div class="formation-row spread">
          ${cb.slice(0, 1).map(p => renderPlayerCard(p, 'defense')).join('')}
          <div></div>
          ${cb.slice(1, 2).map(p => renderPlayerCard(p, 'defense')).join('')}
        </div>
        <div class="formation-row">
          ${s.map(p => renderPlayerCard(p, 'defense')).join('')}
        </div>
      </div>
    `;

    fieldContent.innerHTML = `
      <div class="field-container">
        ${offenseHtml}
        <div class="line-of-scrimmage"></div>
        ${defenseHtml}
      </div>
    `;
  }

  function loadTeams() {
    const teams = runQueryFullParams(`
      SELECT DISTINCT team FROM players WHERE year = ? ORDER BY team
    `, [selectedYear]);

    const offenseVal = offenseTeamSelect.value;
    const defenseVal = defenseTeamSelect.value;

    offenseTeamSelect.innerHTML = '<option value="">Select offense...</option>';
    defenseTeamSelect.innerHTML = '<option value="">Select defense...</option>';

    teams.forEach(t => {
      const opt1 = document.createElement("option");
      opt1.value = t.team;
      opt1.textContent = t.team;
      offenseTeamSelect.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = t.team;
      opt2.textContent = t.team;
      defenseTeamSelect.appendChild(opt2);
    });

    // Restore selections
    if (offenseVal && teams.some(t => t.team === offenseVal)) {
      offenseTeamSelect.value = offenseVal;
    }
    if (defenseVal && teams.some(t => t.team === defenseVal)) {
      defenseTeamSelect.value = defenseVal;
    }
  }

  function loadYears() {
    const years = runQueryFullParams(`SELECT DISTINCT year FROM players ORDER BY year DESC`);

    yearSelect.innerHTML = '';
    years.forEach(y => {
      const opt = document.createElement("option");
      opt.value = y.year;
      opt.textContent = y.year;
      yearSelect.appendChild(opt);
    });

    try {
      const savedYear = localStorage.getItem(STORAGE_KEY_YEAR);
      if (savedYear && years.some(y => String(y.year) === savedYear)) {
        selectedYear = parseInt(savedYear);
        yearSelect.value = savedYear;
      } else if (years.length > 0) {
        selectedYear = years[0].year;
        yearSelect.value = selectedYear;
      }
    } catch(e) {
      if (years.length > 0) {
        selectedYear = years[0].year;
        yearSelect.value = selectedYear;
      }
    }
  }

  async function initDB() {
    try {
      const SQL = await initSqlJs({
        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
      });

      statusEl.textContent = "Downloading database...";
      const response = await fetch("nfl.db?v=2");
      if (!response.ok) throw new Error("Could not load nfl.db");

      const buffer = await response.arrayBuffer();
      db = new SQL.Database(new Uint8Array(buffer));

      loadYears();
      loadTeams();

      // Check URL params first, then localStorage
      const params = new URLSearchParams(window.location.search);
      const urlOff = params.get('offense') || params.get('away');
      const urlDef = params.get('defense') || params.get('home');

      if (urlOff) offenseTeamSelect.value = urlOff;
      if (urlDef) defenseTeamSelect.value = urlDef;

      // Fall back to localStorage if no URL params
      if (!urlOff && !urlDef) {
        try {
          const savedOff = localStorage.getItem(STORAGE_KEY_OFF);
          const savedDef = localStorage.getItem(STORAGE_KEY_DEF);
          if (savedOff) offenseTeamSelect.value = savedOff;
          if (savedDef) defenseTeamSelect.value = savedDef;
        } catch(e) {}
      }

      statusEl.textContent = `Ready (${selectedYear})`;
      statusEl.className = "status ready";

      if (offenseTeamSelect.value && defenseTeamSelect.value) {
        renderFormation();
      }
    } catch (err) {
      statusEl.textContent = "Error: " + err.message;
      statusEl.className = "status error";
      console.error(err);
    }
  }

  yearSelect.addEventListener("change", (e) => {
    selectedYear = parseInt(e.target.value);
    try { localStorage.setItem(STORAGE_KEY_YEAR, String(selectedYear)); } catch(e) {}
    statusEl.textContent = `Ready (${selectedYear})`;
    loadTeams();
    renderFormation();
  });

  offenseTeamSelect.addEventListener("change", (e) => {
    try { localStorage.setItem(STORAGE_KEY_OFF, e.target.value); } catch(e) {}
    renderFormation();
  });

  defenseTeamSelect.addEventListener("change", (e) => {
    try { localStorage.setItem(STORAGE_KEY_DEF, e.target.value); } catch(e) {}
    renderFormation();
  });

  initDB();
</script>
</body>
</html>
