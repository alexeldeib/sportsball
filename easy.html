<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NFL Quiz - Multiple Choice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèà</text></svg>" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #e5e7eb;
    }
    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      line-height: 1.5;
    }
    .app {
      max-width: 500px;
      width: 100%;
      background: radial-gradient(circle at top left, #1f2937, #020617);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.7);
      border: 1px solid rgba(148,163,184,0.3);
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    h1 {
      font-size: 1.4rem;
      margin: 0;
    }
    .gear-btn {
      background: transparent;
      border: none;
      color: #9ca3af;
      font-size: 1.3rem;
      cursor: pointer;
      padding: 0.25rem;
      line-height: 1;
    }
    .gear-btn:hover { color: #e5e7eb; }

    /* Stats row */
    .stats {
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 1rem;
    }
    .stats strong {
      color: #e5e7eb;
    }

    /* Settings panel */
    .settings {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.25s ease-out;
      background: rgba(15,23,42,0.8);
      border-radius: 12px;
      margin-bottom: 0;
    }
    .settings.open {
      max-height: 200px;
      margin-bottom: 1rem;
      padding: 1rem;
      border: 1px solid #4b5563;
    }
    .settings-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    .settings-row:last-child {
      margin-bottom: 0;
    }
    .settings label {
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .settings select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #4b5563;
      color: #e5e7eb;
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }
    button.ghost {
      background: transparent;
      color: #9ca3af;
      border: 1px solid #4b5563;
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    button.ghost:hover {
      background: rgba(107,114,128,0.2);
    }
    button.danger {
      background: rgba(220,38,38,0.2);
      color: #fca5a5;
      border: 1px solid rgba(239,68,68,0.5);
      padding: 0.4rem 0.8rem;
      border-radius: 999px;
      font-size: 0.8rem;
      cursor: pointer;
    }
    button.danger:hover {
      background: rgba(220,38,38,0.4);
    }
    input.snap-input {
      width: 4rem;
      text-align: center;
      background: #020617;
      border: 1px solid #4b5563;
      border-radius: 999px;
      color: #e5e7eb;
      padding: 0.3rem 0.5rem;
      font-size: 0.85rem;
    }
    input.snap-input:focus {
      outline: none;
      border-color: #6366f1;
    }

    /* Question card */
    .question-card {
      padding: 1.25rem;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(30,64,175,0.85), rgba(15,23,42,0.98));
      border: 1px solid rgba(129,140,248,0.85);
    }
    .question-main {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
      text-align: center;
    }

    /* Choice buttons */
    .choices {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .choice-btn {
      width: 100%;
      padding: 1rem;
      border-radius: 12px;
      border: 2px solid #4b5563;
      background: rgba(15,23,42,0.6);
      color: #e5e7eb;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
    }
    .choice-btn:hover:not(:disabled) {
      border-color: #6366f1;
      background: rgba(99,102,241,0.2);
    }
    .choice-btn.correct {
      border-color: #22c55e;
      background: rgba(22,163,74,0.3);
      color: #bbf7d0;
    }
    .choice-btn.wrong {
      border-color: #ef4444;
      background: rgba(220,38,38,0.3);
      color: #fecaca;
    }
    .choice-btn:disabled {
      cursor: default;
    }

    button.primary {
      width: 100%;
      border-radius: 999px;
      padding: 0.7rem 1rem;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      background: linear-gradient(135deg, #6366f1, #4f46e5);
      color: white;
      box-shadow: 0 8px 20px rgba(79,70,229,0.4);
      display: none;
    }
    button.primary.visible {
      display: block;
    }

    /* Footer */
    .footer {
      margin-top: 1rem;
      text-align: center;
      font-size: 0.8rem;
    }
    .footer a {
      color: #818cf8;
      text-decoration: none;
    }

    @media (max-width: 400px) {
      .app { padding: 16px; }
      .question-main { font-size: 1.3rem; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="header">
    <h1>NFL Quiz (Easy)</h1>
    <button class="gear-btn" id="gear-btn" title="Settings">&#9881;</button>
  </div>

  <div class="stats">
    <span><strong id="seen-count">0</strong> seen</span> ¬∑
    <span><strong id="correct-count">0</strong> correct</span> ¬∑
    <span><strong id="accuracy">0%</strong></span>
  </div>

  <div class="settings" id="settings">
    <div class="settings-row">
      <label for="mode">Mode:</label>
      <select id="mode">
        <option value="name_to_teampos">Name ‚Üí Team & Position</option>
        <option value="teampos_to_name">Team & Position ‚Üí Name</option>
        <option value="mixed">Mixed (random)</option>
      </select>
    </div>
    <div class="settings-row">
      <label for="difficulty">Difficulty:</label>
      <select id="difficulty">
        <option value="50">Casual (Top 50)</option>
        <option value="100">Easy (Top 100)</option>
        <option value="200" selected>Medium (Top 200)</option>
        <option value="350">Hard (Top 350)</option>
        <option value="500">Diehard (Top 500)</option>
        <option value="750">Insane (Top 750)</option>
      </select>
    </div>
    <div class="settings-row">
      <button class="danger" id="btn-reset">Reset stats</button>
    </div>
  </div>

  <div class="question-card">
    <div class="question-main" id="question-main">Loading...</div>

    <div class="choices">
      <button class="choice-btn" id="choice-0"></button>
      <button class="choice-btn" id="choice-1"></button>
    </div>

    <button class="primary" id="btn-next">Next</button>
  </div>

  <div class="footer">
    <a href="index.html">Free Response</a> ¬∑ <a href="game.html">Daily</a> ¬∑ <a href="stats-quiz.html">Stats Quiz</a> ¬∑ <a href="stats.html">Explorer</a>
  </div>
</div>

<script>
  const POSITION_MAP = {
    QB: "Quarterback", RB: "Running Back", FB: "Fullback", WR: "Wide Receiver",
    TE: "Tight End", OL: "Offensive Lineman", OT: "Offensive Tackle", OG: "Offensive Guard", C: "Center",
    G: "Guard", T: "Tackle", DL: "Defensive Lineman", DE: "Defensive End",
    DT: "Defensive Tackle", NT: "Nose Tackle", EDGE: "Edge Rusher", LB: "Linebacker",
    OLB: "Outside Linebacker", ILB: "Inside Linebacker", MLB: "Middle Linebacker",
    DB: "Defensive Back", CB: "Cornerback", S: "Safety", FS: "Free Safety",
    SS: "Strong Safety", K: "Kicker", P: "Punter", LS: "Long Snapper"
  };

  const STORAGE_KEY_STATS = "nflQuizEasyStats_v1";
  const STORAGE_KEY_GLOBAL = "nflQuizEasyGlobal_v1";
  const STORAGE_KEY_MODE = "nflQuizEasyMode_v1";
  const STORAGE_KEY_DIFF = "nflQuizEasyDiff_v1";

  let allPlayers = [];
  let players = [];
  let topN = 200;
  let stats = {};
  let globalStats = { seen: 0, correct: 0 };
  let currentCard = null;
  let currentQuestionMode = "name_to_teampos";
  let correctIndex = -1;
  let answered = false;

  const gearBtn = document.getElementById("gear-btn");
  const settingsEl = document.getElementById("settings");
  const modeSelect = document.getElementById("mode");
  const difficultySelect = document.getElementById("difficulty");
  const seenEl = document.getElementById("seen-count");
  const correctEl = document.getElementById("correct-count");
  const accuracyEl = document.getElementById("accuracy");
  const questionMain = document.getElementById("question-main");
  const choice0 = document.getElementById("choice-0");
  const choice1 = document.getElementById("choice-1");
  const btnNext = document.getElementById("btn-next");
  const btnReset = document.getElementById("btn-reset");

  function getPlayerSnaps(p) {
    const s = p.stats || {};
    return (s.off_snp || 0) + (s.def_snp || 0);
  }

  function filterPlayers() {
    players = allPlayers.slice(0, topN);
  }

  function setDifficulty(val) {
    topN = parseInt(val, 10) || 200;
    difficultySelect.value = val;
    filterPlayers();
    try { localStorage.setItem(STORAGE_KEY_DIFF, val); } catch(e) {}
  }

  function displayPosition(abbr) {
    const key = String(abbr || "").toUpperCase();
    return POSITION_MAP[key] ? key + " ‚Äî " + POSITION_MAP[key] : key;
  }

  function loadStats() {
    try {
      const s = localStorage.getItem(STORAGE_KEY_STATS);
      if (s) stats = JSON.parse(s);
      const g = localStorage.getItem(STORAGE_KEY_GLOBAL);
      if (g) globalStats = JSON.parse(g);
      const m = localStorage.getItem(STORAGE_KEY_MODE);
      if (m) modeSelect.value = m;
      const diff = localStorage.getItem(STORAGE_KEY_DIFF);
      if (diff) {
        topN = parseInt(diff, 10) || 200;
        difficultySelect.value = diff;
      }
    } catch (e) {}
    updateStatsUI();
  }

  function saveStats() {
    try {
      localStorage.setItem(STORAGE_KEY_STATS, JSON.stringify(stats));
      localStorage.setItem(STORAGE_KEY_GLOBAL, JSON.stringify(globalStats));
      localStorage.setItem(STORAGE_KEY_MODE, modeSelect.value);
    } catch (e) {}
  }

  function cardKey(card) {
    return ((card.name || "") + "|" + (card.team || "") + "|" + (card.position || "")).toLowerCase();
  }

  function updateStatsUI() {
    seenEl.textContent = globalStats.seen;
    correctEl.textContent = globalStats.correct;
    const acc = globalStats.seen > 0 ? Math.round((globalStats.correct / globalStats.seen) * 100) : 0;
    accuracyEl.textContent = acc + "%";
  }

  function pickNextCard() {
    if (!players.length) return null;
    const now = Date.now();
    let best = null, bestScore = Infinity;
    for (const p of players) {
      const s = stats[cardKey(p)] || { correct: 0, wrong: 0, lastSeen: 0 };
      const mastery = s.correct - s.wrong;
      const daysSince = s.lastSeen ? (now - s.lastSeen) / 86400000 : 999;
      const score = mastery - daysSince + Math.random() * 0.5;
      if (score < bestScore) { bestScore = score; best = p; }
    }
    return best;
  }

  function getRandomOther(exclude) {
    // Get a random player different from exclude
    const others = players.filter(p => p !== exclude);
    if (!others.length) return exclude;
    return others[Math.floor(Math.random() * others.length)];
  }

  function resolveMode() {
    const mode = modeSelect.value;
    if (mode === "mixed") {
      return Math.random() < 0.5 ? "name_to_teampos" : "teampos_to_name";
    }
    return mode;
  }

  function showQuestion(card) {
    if (!card) {
      questionMain.textContent = "No players loaded";
      return;
    }

    answered = false;
    btnNext.classList.remove("visible");
    choice0.className = "choice-btn";
    choice1.className = "choice-btn";
    choice0.disabled = false;
    choice1.disabled = false;

    const other = getRandomOther(card);
    correctIndex = Math.random() < 0.5 ? 0 : 1;
    const wrongIndex = 1 - correctIndex;

    if (currentQuestionMode === "name_to_teampos") {
      questionMain.textContent = card.name;
      const correctAnswer = card.team + " ¬∑ " + displayPosition(card.position);
      const wrongAnswer = other.team + " ¬∑ " + displayPosition(other.position);

      if (correctIndex === 0) {
        choice0.textContent = correctAnswer;
        choice1.textContent = wrongAnswer;
      } else {
        choice0.textContent = wrongAnswer;
        choice1.textContent = correctAnswer;
      }
    } else {
      questionMain.textContent = card.team + " ‚Äî " + displayPosition(card.position);

      if (correctIndex === 0) {
        choice0.textContent = card.name;
        choice1.textContent = other.name;
      } else {
        choice0.textContent = other.name;
        choice1.textContent = card.name;
      }
    }
  }

  function handleChoice(chosenIndex) {
    if (answered) return;
    answered = true;

    const isCorrect = chosenIndex === correctIndex;
    const chosenBtn = chosenIndex === 0 ? choice0 : choice1;
    const correctBtn = correctIndex === 0 ? choice0 : choice1;

    if (isCorrect) {
      chosenBtn.classList.add("correct");
    } else {
      chosenBtn.classList.add("wrong");
      correctBtn.classList.add("correct");
    }

    choice0.disabled = true;
    choice1.disabled = true;
    btnNext.classList.add("visible");

    // Update stats
    const key = cardKey(currentCard);
    if (!stats[key]) stats[key] = { correct: 0, wrong: 0, lastSeen: 0 };
    if (isCorrect) {
      stats[key].correct++;
      globalStats.correct++;
    } else {
      stats[key].wrong++;
    }
    stats[key].lastSeen = Date.now();
    globalStats.seen++;
    saveStats();
    updateStatsUI();
  }

  function nextQuestion() {
    currentCard = pickNextCard();
    currentQuestionMode = resolveMode();
    showQuestion(currentCard);
  }

  async function loadPlayers() {
    try {
      const resp = await fetch("players-with-stats-2025.json", { cache: "no-store" });
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const parsed = await resp.json();
      allPlayers = parsed
        .map(p => ({
          name: String(p.name || ((p.first_name || "") + " " + (p.last_name || ""))).trim(),
          team: String(p.team || "").trim(),
          position: String(p.position || "").trim(),
          stats: p.stats || {}
        }))
        .filter(p => p.name && p.team && p.position)
        .sort((a, b) => getPlayerSnaps(b) - getPlayerSnaps(a));
      filterPlayers();
      if (players.length) nextQuestion();
      else questionMain.textContent = "No players found";
    } catch (err) {
      questionMain.textContent = "Could not load players";
    }
  }

  // Events
  gearBtn.addEventListener("click", () => settingsEl.classList.toggle("open"));

  modeSelect.addEventListener("change", () => {
    currentQuestionMode = resolveMode();
    showQuestion(currentCard);
    saveStats();
  });

  choice0.addEventListener("click", () => handleChoice(0));
  choice1.addEventListener("click", () => handleChoice(1));
  btnNext.addEventListener("click", nextQuestion);

  btnReset.addEventListener("click", () => {
    if (!confirm("Reset all stats?")) return;
    stats = {}; globalStats = { seen: 0, correct: 0 };
    saveStats(); updateStatsUI();
  });

  difficultySelect.addEventListener("change", (e) => setDifficulty(e.target.value));

  document.addEventListener("keydown", (e) => {
    // 1 or 2 to select choice
    if (!answered && (e.key === "1" || e.key === "2")) {
      e.preventDefault();
      handleChoice(e.key === "1" ? 0 : 1);
      return;
    }
    // Enter or arrow keys for next
    if (answered && (e.key === "Enter" || e.key === "ArrowRight" || e.key === "ArrowDown")) {
      e.preventDefault();
      nextQuestion();
    }
  });

  // Init
  loadStats();
  currentQuestionMode = resolveMode();
  loadPlayers();
</script>
</body>
</html>
