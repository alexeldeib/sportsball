<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NFL Roster Quiz - Depth Charts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'></text></svg>" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-deep: #030712;
      --bg-card: #0c1322;
      --bg-row-starter: rgba(34, 197, 94, 0.08);
      --bg-row-backup: transparent;
      --border-starter: #22c55e;
      --border-backup: #374151;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-offense: #22c55e;
      --accent-defense: #dc2626;
      --accent-special: #8b5cf6;
    }

    body {
      font-family: 'Source Sans 3', system-ui, sans-serif;
      background: var(--bg-deep);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 1.5rem 1rem 2rem;
    }

    /* Header */
    header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    h1 {
      font-family: 'Oswald', sans-serif;
      font-size: 1.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      margin-bottom: 0.25rem;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    /* Team selector */
    .team-selector {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }

    .team-selector select {
      background: var(--bg-card);
      border: 1px solid #374151;
      border-radius: 6px;
      color: var(--text-primary);
      padding: 0.6rem 1rem;
      font-family: inherit;
      font-size: 1rem;
      cursor: pointer;
    }

    .team-selector select#year-select {
      min-width: 90px;
      font-family: 'Oswald', sans-serif;
      font-weight: 500;
    }

    .team-selector select#team-select {
      min-width: 220px;
    }

    .team-selector select:focus {
      outline: none;
      border-color: var(--accent-offense);
    }

    /* Status */
    .status {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 1rem;
    }
    .status.loading { color: #fbbf24; }
    .status.ready { color: var(--accent-offense); }
    .status.error { color: var(--accent-defense); }

    /* Legend */
    .legend {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-bottom: 1.5rem;
      padding: 0.75rem 1rem;
      background: var(--bg-card);
      border-radius: 8px;
      font-size: 0.8rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--text-secondary);
    }

    .legend-swatch {
      width: 14px;
      height: 14px;
      border-radius: 3px;
      border-left: 3px solid;
    }

    .legend-swatch.starter {
      background: var(--bg-row-starter);
      border-color: var(--border-starter);
    }

    .legend-swatch.backup {
      background: var(--bg-row-backup);
      border-color: var(--border-backup);
    }

    /* Main grid */
    .roster-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1.25rem;
    }

    @media (max-width: 768px) {
      .roster-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Section */
    .section {
      background: var(--bg-card);
      border-radius: 10px;
      overflow: hidden;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.875rem 1rem;
      font-family: 'Oswald', sans-serif;
      font-size: 0.9rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .section-header.offense {
      color: var(--accent-offense);
      background: rgba(34, 197, 94, 0.06);
    }
    .section-header.defense {
      color: var(--accent-defense);
      background: rgba(220, 38, 38, 0.06);
    }
    .section-header.special {
      color: var(--accent-special);
      background: rgba(139, 92, 246, 0.06);
    }

    .section-header svg {
      width: 16px;
      height: 16px;
      opacity: 0.8;
    }

    .section-body {
      padding: 0.5rem 0;
    }

    /* Position group */
    .position-group {
      padding: 0.5rem 1rem;
    }

    .position-group + .position-group {
      border-top: 1px solid rgba(255,255,255,0.04);
    }

    .position-label {
      font-family: 'Oswald', sans-serif;
      font-size: 0.7rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 0.375rem;
    }

    /* Player row */
    .player-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.75rem;
      align-items: center;
      padding: 0.4rem 0.6rem;
      margin: 0.2rem 0;
      border-radius: 4px;
      border-left: 3px solid transparent;
      transition: background 0.15s ease;
    }

    .player-row:hover {
      background: rgba(255,255,255,0.03);
    }

    .player-row.starter {
      background: var(--bg-row-starter);
      border-left-color: var(--border-starter);
    }

    .player-row.backup {
      border-left-color: var(--border-backup);
    }

    .player-name {
      font-weight: 500;
      font-size: 0.9rem;
    }

    .player-row.backup .player-name {
      color: var(--text-secondary);
      font-weight: 400;
    }

    .player-stats {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-align: right;
      white-space: nowrap;
    }

    .player-row.starter .player-stats {
      color: var(--text-secondary);
    }

    /* Special teams - full width */
    .section.full-width {
      grid-column: 1 / -1;
    }

    .section.full-width .section-body {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0;
    }

    .section.full-width .position-group {
      border-top: none;
    }

    .section.full-width .position-group + .position-group {
      border-left: 1px solid rgba(255,255,255,0.04);
    }

    @media (max-width: 600px) {
      .section.full-width .section-body {
        grid-template-columns: 1fr;
      }
      .section.full-width .position-group + .position-group {
        border-left: none;
        border-top: 1px solid rgba(255,255,255,0.04);
      }
    }

    /* No data state */
    .no-data {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .no-data-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      opacity: 0.5;
    }

    /* Footer */
    .footer {
      margin-top: 2rem;
      padding-top: 1.25rem;
      border-top: 1px solid rgba(255,255,255,0.06);
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .footer a {
      color: var(--text-secondary);
      text-decoration: none;
      transition: color 0.15s ease;
    }

    .footer a:hover {
      color: var(--text-primary);
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Depth Charts</h1>
    <p class="subtitle">Team rosters organized by position</p>
  </header>

  <div class="team-selector">
    <select id="year-select">
      <option value="">Loading...</option>
    </select>
    <select id="team-select">
      <option value="">Loading teams...</option>
    </select>
  </div>

  <div class="status loading" id="status">Loading database...</div>

  <div class="legend" id="legend" style="display: none;">
    <div class="legend-item">
      <div class="legend-swatch starter"></div>
      <span>Starter (50%+ games started or 40%+ snap share)</span>
    </div>
    <div class="legend-item">
      <div class="legend-swatch backup"></div>
      <span>Backup / Rotational</span>
    </div>
  </div>

  <div id="roster-content">
    <div class="no-data">
      <div class="no-data-icon"></div>
      <div>Select a team to view their depth chart</div>
    </div>
  </div>

  <div class="footer">
    <a href="index.html">Home</a> 路 <a href="practice.html">Practice</a> 路 <a href="easy.html">Multiple Choice</a> 路 <a href="game.html">Daily</a> 路 <a href="trivia.html">Trivia</a> 路 <a href="stats-quiz.html">Stats Quiz</a> 路 <a href="explorer.html">SQL Explorer</a>
  </div>
</div>

<script>
  const STORAGE_KEY_TEAM = "nflTeamStudy_team_v1";
  const STORAGE_KEY_YEAR = "nflTeamStudy_year_v1";
  let selectedYear = 2025;

  const OFFENSE_POSITIONS = {
    "Quarterbacks": ["QB"],
    "Running Backs": ["RB", "FB"],
    "Wide Receivers": ["WR"],
    "Tight Ends": ["TE"],
    "Offensive Line": ["OL", "OT", "C", "G", "T"]
  };

  const DEFENSE_POSITIONS = {
    "Defensive Line": ["DL", "DE", "DT", "NT"],
    "Edge Rushers": ["EDGE"],
    "Linebackers": ["LB", "OLB", "ILB", "MLB"],
    "Cornerbacks": ["CB"],
    "Safeties": ["S", "FS", "SS", "DB"]
  };

  const SPECIAL_POSITIONS = {
    "Kickers": ["K"],
    "Punters": ["P"],
    "Long Snappers": ["LS"]
  };

  let db = null;

  const statusEl = document.getElementById("status");
  const yearSelect = document.getElementById("year-select");
  const teamSelect = document.getElementById("team-select");
  const rosterContent = document.getElementById("roster-content");
  const legendEl = document.getElementById("legend");

  function runQueryFull(sql) {
    try {
      const result = db.exec(sql);
      if (!result.length) return [];
      const cols = result[0].columns;
      return result[0].values.map(row => {
        const obj = {};
        cols.forEach((c, i) => obj[c] = row[i]);
        return obj;
      });
    } catch (e) {
      console.error("SQL error:", e, sql);
      return [];
    }
  }

  function formatStats(player) {
    const parts = [];

    if (player.pass_yd > 0) {
      parts.push(`${player.pass_yd} yds, ${player.pass_td || 0} TD`);
    }
    if (player.rush_yd > 0) {
      parts.push(`${player.rush_yd} rush`);
    }
    if (player.rec_yd > 0) {
      parts.push(`${player.rec || 0} rec, ${player.rec_yd} yds`);
    }
    if (player.idp_tkl > 0) {
      let defStr = `${player.idp_tkl} tkl`;
      if (player.idp_sack > 0) defStr += `, ${player.idp_sack} sk`;
      parts.push(defStr);
    }

    if (parts.length === 0) {
      const snaps = (player.off_snp || 0) + (player.def_snp || 0);
      if (snaps > 0) return `${snaps} snaps`;
      return "";
    }

    return parts.join(" 路 ");
  }

  function isStarter(player, maxSnaps) {
    const snaps = (player.off_snp || 0) + (player.def_snp || 0);
    const gamesStarted = player.gs || 0;
    const gamesPlayed = player.gp || 0;

    if (gamesPlayed > 0 && gamesStarted >= gamesPlayed * 0.5) return true;
    if (maxSnaps > 0 && snaps >= maxSnaps * 0.4) return true;

    return false;
  }

  function renderPositionGroup(players, groupName, positions, isOffense) {
    const groupPlayers = players.filter(p => positions.includes(p.position));

    if (groupPlayers.length === 0) return "";

    groupPlayers.sort((a, b) => {
      const aSnaps = isOffense ? (a.off_snp || 0) : (a.def_snp || 0);
      const bSnaps = isOffense ? (b.off_snp || 0) : (b.def_snp || 0);
      return bSnaps - aSnaps;
    });

    const maxSnaps = groupPlayers.reduce((max, p) => {
      const snaps = (p.off_snp || 0) + (p.def_snp || 0);
      return Math.max(max, snaps);
    }, 0);

    const rows = groupPlayers.map(p => {
      const starter = isStarter(p, maxSnaps);
      const stats = formatStats(p);
      return `
        <div class="player-row ${starter ? 'starter' : 'backup'}">
          <span class="player-name">${p.name}</span>
          <span class="player-stats">${stats}</span>
        </div>
      `;
    }).join("");

    return `
      <div class="position-group">
        <div class="position-label">${groupName}</div>
        ${rows}
      </div>
    `;
  }

  function renderTeamRoster(team) {
    if (!team) {
      legendEl.style.display = "none";
      rosterContent.innerHTML = `
        <div class="no-data">
          <div class="no-data-icon"></div>
          <div>Select a team to view their depth chart</div>
        </div>
      `;
      return;
    }

    const players = runQueryFull(`
      SELECT name, position, gp, gs, off_snp, def_snp,
             pass_yd, pass_td, pass_int, rush_yd, rush_td,
             rec, rec_yd, rec_td, idp_tkl, idp_sack, idp_int
      FROM players
      WHERE year = ${selectedYear} AND team = '${team}'
      ORDER BY (COALESCE(off_snp, 0) + COALESCE(def_snp, 0)) DESC
    `);

    if (players.length === 0) {
      legendEl.style.display = "none";
      rosterContent.innerHTML = `
        <div class="no-data">
          <div class="no-data-icon"></div>
          <div>No players found for this team</div>
        </div>
      `;
      return;
    }

    legendEl.style.display = "flex";

    let offenseHtml = "";
    for (const [groupName, positions] of Object.entries(OFFENSE_POSITIONS)) {
      offenseHtml += renderPositionGroup(players, groupName, positions, true);
    }

    let defenseHtml = "";
    for (const [groupName, positions] of Object.entries(DEFENSE_POSITIONS)) {
      defenseHtml += renderPositionGroup(players, groupName, positions, false);
    }

    let specialHtml = "";
    for (const [groupName, positions] of Object.entries(SPECIAL_POSITIONS)) {
      specialHtml += renderPositionGroup(players, groupName, positions, true);
    }

    rosterContent.innerHTML = `
      <div class="roster-grid">
        <div class="section">
          <div class="section-header offense">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 8v8M8 12h8"/>
            </svg>
            Offense
          </div>
          <div class="section-body">
            ${offenseHtml || '<div class="no-data">No offensive players</div>'}
          </div>
        </div>
        <div class="section">
          <div class="section-header defense">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
            Defense
          </div>
          <div class="section-body">
            ${defenseHtml || '<div class="no-data">No defensive players</div>'}
          </div>
        </div>
        <div class="section full-width">
          <div class="section-header special">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
            </svg>
            Special Teams
          </div>
          <div class="section-body">
            ${specialHtml || '<div class="no-data">No specialists</div>'}
          </div>
        </div>
      </div>
    `;
  }

  function loadYears() {
    const years = runQueryFull(`
      SELECT DISTINCT year FROM players ORDER BY year DESC
    `);

    yearSelect.innerHTML = '';
    years.forEach(y => {
      const opt = document.createElement("option");
      opt.value = y.year;
      opt.textContent = y.year;
      yearSelect.appendChild(opt);
    });

    // Restore saved year or use most recent
    try {
      const savedYear = localStorage.getItem(STORAGE_KEY_YEAR);
      if (savedYear && years.some(y => String(y.year) === savedYear)) {
        selectedYear = parseInt(savedYear);
        yearSelect.value = savedYear;
      } else if (years.length > 0) {
        selectedYear = years[0].year;
        yearSelect.value = selectedYear;
      }
    } catch(e) {
      if (years.length > 0) {
        selectedYear = years[0].year;
        yearSelect.value = selectedYear;
      }
    }
  }

  function loadTeams() {
    const teams = runQueryFull(`
      SELECT DISTINCT team FROM players WHERE year = ${selectedYear} ORDER BY team
    `);

    teamSelect.innerHTML = '<option value="">Select a team...</option>';
    teams.forEach(t => {
      const opt = document.createElement("option");
      opt.value = t.team;
      opt.textContent = t.team;
      teamSelect.appendChild(opt);
    });

    try {
      const savedTeam = localStorage.getItem(STORAGE_KEY_TEAM);
      if (savedTeam && teams.some(t => t.team === savedTeam)) {
        teamSelect.value = savedTeam;
        renderTeamRoster(savedTeam);
      }
    } catch(e) {}
  }

  async function initDB() {
    try {
      const SQL = await initSqlJs({
        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
      });

      statusEl.textContent = "Downloading database...";
      const response = await fetch("nfl.db");
      if (!response.ok) throw new Error("Could not load nfl.db");

      const buffer = await response.arrayBuffer();
      db = new SQL.Database(new Uint8Array(buffer));

      // Load years first
      loadYears();

      const countResult = db.exec(`SELECT COUNT(DISTINCT team) FROM players WHERE year = ${selectedYear}`);
      const teamCount = countResult[0]?.values[0]?.[0] || 0;

      if (teamCount === 0) {
        throw new Error(`No ${selectedYear} team data found`);
      }

      statusEl.textContent = `${teamCount} teams (${selectedYear})`;
      statusEl.className = "status ready";

      loadTeams();
    } catch (err) {
      statusEl.textContent = "Error: " + err.message;
      statusEl.className = "status error";
      console.error(err);
    }
  }

  yearSelect.addEventListener("change", (e) => {
    selectedYear = parseInt(e.target.value);
    try { localStorage.setItem(STORAGE_KEY_YEAR, String(selectedYear)); } catch(e) {}

    // Update status
    const countResult = db.exec(`SELECT COUNT(DISTINCT team) FROM players WHERE year = ${selectedYear}`);
    const teamCount = countResult[0]?.values[0]?.[0] || 0;
    statusEl.textContent = `${teamCount} teams (${selectedYear})`;

    // Reload teams for this year and clear current roster
    loadTeams();
    renderTeamRoster(teamSelect.value);
  });

  teamSelect.addEventListener("change", (e) => {
    const team = e.target.value;
    try { localStorage.setItem(STORAGE_KEY_TEAM, team); } catch(e) {}
    renderTeamRoster(team);
  });

  initDB();
</script>
</body>
</html>
