<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NFL Position Leaders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'></text></svg>" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-deep: #030712;
      --bg-card: #0c1322;
      --bg-row-top: rgba(234, 179, 8, 0.1);
      --bg-row-hover: rgba(255, 255, 255, 0.03);
      --border-gold: #eab308;
      --border-silver: #94a3b8;
      --border-bronze: #d97706;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-primary: #3b82f6;
    }

    body {
      font-family: 'Source Sans 3', system-ui, sans-serif;
      background: var(--bg-deep);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 1.5rem 1rem 2rem;
    }

    header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    h1 {
      font-family: 'Oswald', sans-serif;
      font-size: 1.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      margin-bottom: 0.25rem;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
      flex-wrap: wrap;
    }

    .controls select {
      background: var(--bg-card);
      border: 1px solid #374151;
      border-radius: 6px;
      color: var(--text-primary);
      padding: 0.6rem 1rem;
      font-family: inherit;
      font-size: 1rem;
      cursor: pointer;
      min-width: 140px;
    }

    .controls select:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    .status {
      font-size: 0.8rem;
      color: var(--text-muted);
      text-align: center;
      margin-bottom: 1rem;
    }
    .status.loading { color: #fbbf24; }
    .status.ready { color: #22c55e; }
    .status.error { color: #dc2626; }

    .leaders-table {
      background: var(--bg-card);
      border-radius: 10px;
      overflow: hidden;
      overflow-x: auto;
    }

    .table-header, .player-row {
      display: grid;
      gap: 0.5rem;
      align-items: center;
      padding: 0.6rem 1rem;
      min-width: max-content;
    }

    .table-header {
      background: rgba(255, 255, 255, 0.03);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      font-family: 'Oswald', sans-serif;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      padding: 0.75rem 1rem;
    }

    .player-row {
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      transition: background 0.15s ease;
    }

    .player-row:last-child {
      border-bottom: none;
    }

    .player-row:hover {
      background: var(--bg-row-hover);
    }

    .player-row.rank-1 {
      background: var(--bg-row-top);
    }

    .col-rank {
      width: 40px;
      font-family: 'Oswald', sans-serif;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-muted);
    }

    .player-row.rank-1 .col-rank { color: var(--border-gold); }
    .player-row.rank-2 .col-rank { color: var(--border-silver); }
    .player-row.rank-3 .col-rank { color: var(--border-bronze); }

    .col-player {
      min-width: 160px;
    }

    .player-name {
      font-weight: 500;
      font-size: 0.95rem;
    }

    .player-team {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .col-stat {
      text-align: right;
      min-width: 70px;
    }

    .table-header .col-stat {
      cursor: pointer;
      user-select: none;
      transition: color 0.15s ease;
    }

    .table-header .col-stat:hover {
      color: var(--accent-primary);
    }

    .table-header .col-stat.active {
      color: var(--accent-primary);
    }

    .player-row .col-stat {
      font-family: 'Oswald', sans-serif;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .player-row .col-stat.active {
      color: var(--text-primary);
    }

    .player-row.rank-1 .col-stat.active {
      color: var(--border-gold);
    }

    .sort-indicator {
      margin-left: 0.25rem;
      opacity: 0.8;
    }

    .no-data {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-muted);
      font-size: 0.95rem;
    }

    .no-data-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
      opacity: 0.5;
    }

    .footer {
      margin-top: 2rem;
      padding-top: 1.25rem;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .footer a {
      color: var(--text-secondary);
      text-decoration: none;
      transition: color 0.15s ease;
    }

    .footer a:hover {
      color: var(--text-primary);
    }

    @media (max-width: 600px) {
      .container { padding: 1rem 0.5rem; }
      .table-header, .player-row { padding: 0.5rem 0.75rem; }
      .col-stat { min-width: 55px; font-size: 0.85rem; }
      .table-header .col-stat { font-size: 0.65rem; }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>Position Leaders</h1>
    <p class="subtitle">Click any column to sort</p>
  </header>

  <div class="controls">
    <select id="year-select">
      <option value="">Loading...</option>
    </select>
    <select id="position-select">
      <option value="">Select position...</option>
    </select>
  </div>

  <div class="status loading" id="status">Loading database...</div>

  <div id="leaders-content">
    <div class="no-data">
      <div class="no-data-icon"></div>
      <div>Select a position to view leaders</div>
    </div>
  </div>

  <div class="footer">
    <a href="index.html">Home</a> 路 <a href="practice.html">Practice</a> 路 <a href="easy.html">Multiple Choice</a> 路 <a href="game.html">Daily</a> 路 <a href="trivia.html">Trivia</a> 路 <a href="stats-quiz.html">Stats Quiz</a> 路 <a href="team-study.html">Depth Charts</a> 路 <a href="explorer.html">SQL Explorer</a>
  </div>
</div>

<script>
  const STORAGE_KEY_YEAR = "nflPositionLeaders_year_v2";
  const STORAGE_KEY_POS = "nflPositionLeaders_pos_v2";
  const STORAGE_KEY_SORT = "nflPositionLeaders_sort_v2";

  let db = null;
  let selectedYear = 2025;
  let sortField = null;
  let sortAscending = false;

  // Each position defines which stat columns to show
  const POSITIONS = {
    "QB": {
      label: "Quarterbacks",
      columns: [
        { field: "pass_yd", label: "Pass Yds" },
        { field: "pass_td", label: "TD" },
        { field: "pass_int", label: "INT" },
        { field: "rush_yd", label: "Rush" },
      ],
      defaultSort: "pass_yd"
    },
    "RB": {
      label: "Running Backs",
      columns: [
        { field: "rush_yd", label: "Rush Yds" },
        { field: "rush_td", label: "Rush TD" },
        { field: "rec", label: "Rec" },
        { field: "rec_yd", label: "Rec Yds" },
      ],
      defaultSort: "rush_yd"
    },
    "WR": {
      label: "Wide Receivers",
      columns: [
        { field: "rec_yd", label: "Rec Yds" },
        { field: "rec", label: "Rec" },
        { field: "rec_td", label: "TD" },
      ],
      defaultSort: "rec_yd"
    },
    "TE": {
      label: "Tight Ends",
      columns: [
        { field: "rec_yd", label: "Rec Yds" },
        { field: "rec", label: "Rec" },
        { field: "rec_td", label: "TD" },
      ],
      defaultSort: "rec_yd"
    },
    "LB": {
      label: "Linebackers",
      columns: [
        { field: "idp_tkl", label: "Tackles" },
        { field: "idp_sack", label: "Sacks" },
        { field: "idp_int", label: "INT" },
      ],
      defaultSort: "idp_tkl"
    },
    "CB": {
      label: "Cornerbacks",
      columns: [
        { field: "idp_tkl", label: "Tackles" },
        { field: "idp_int", label: "INT" },
      ],
      defaultSort: "idp_tkl"
    },
    "S": {
      label: "Safeties",
      columns: [
        { field: "idp_tkl", label: "Tackles" },
        { field: "idp_int", label: "INT" },
        { field: "idp_sack", label: "Sacks" },
      ],
      defaultSort: "idp_tkl"
    },
    "DE": {
      label: "Defensive Ends",
      columns: [
        { field: "idp_sack", label: "Sacks" },
        { field: "idp_tkl", label: "Tackles" },
      ],
      defaultSort: "idp_sack"
    },
    "DT": {
      label: "Defensive Tackles",
      columns: [
        { field: "idp_tkl", label: "Tackles" },
        { field: "idp_sack", label: "Sacks" },
      ],
      defaultSort: "idp_tkl"
    },
    "EDGE": {
      label: "Edge Rushers",
      columns: [
        { field: "idp_sack", label: "Sacks" },
        { field: "idp_tkl", label: "Tackles" },
      ],
      defaultSort: "idp_sack"
    },
  };

  const statusEl = document.getElementById("status");
  const yearSelect = document.getElementById("year-select");
  const positionSelect = document.getElementById("position-select");
  const leadersContent = document.getElementById("leaders-content");

  function runQueryFullParams(sql, params = []) {
    try {
      const stmt = db.prepare(sql);
      if (params.length) stmt.bind(params);
      const results = [];
      const cols = stmt.getColumnNames();
      while (stmt.step()) {
        const row = stmt.get();
        const obj = {};
        cols.forEach((c, i) => obj[c] = row[i]);
        results.push(obj);
      }
      stmt.free();
      return results;
    } catch (e) {
      console.error("SQL error:", e, sql, params);
      return [];
    }
  }

  function populatePositions() {
    positionSelect.innerHTML = '<option value="">Select position...</option>';
    for (const [pos, config] of Object.entries(POSITIONS)) {
      const opt = document.createElement("option");
      opt.value = pos;
      opt.textContent = config.label;
      positionSelect.appendChild(opt);
    }

    try {
      const savedPos = localStorage.getItem(STORAGE_KEY_POS);
      if (savedPos && POSITIONS[savedPos]) {
        positionSelect.value = savedPos;
        // Restore sort if saved
        const savedSort = localStorage.getItem(STORAGE_KEY_SORT);
        if (savedSort) {
          const [field, dir] = savedSort.split(':');
          sortField = field;
          sortAscending = dir === 'asc';
        } else {
          sortField = POSITIONS[savedPos].defaultSort;
          sortAscending = false;
        }
        renderLeaders();
      }
    } catch(e) {}
  }

  function renderLeaders() {
    const position = positionSelect.value;

    if (!position || !POSITIONS[position]) {
      leadersContent.innerHTML = `
        <div class="no-data">
          <div class="no-data-icon"></div>
          <div>Select a position to view leaders</div>
        </div>
      `;
      return;
    }

    const config = POSITIONS[position];
    const columns = config.columns;

    // Use default sort if sortField not set or invalid for this position
    if (!sortField || !columns.find(c => c.field === sortField)) {
      sortField = config.defaultSort;
      sortAscending = false;
    }

    const sortOrder = sortAscending ? "ASC" : "DESC";
    const sortIndicator = sortAscending ? "&#9650;" : "&#9660;";

    // Build SELECT with all column fields
    const selectFields = columns.map(c => `COALESCE(${c.field}, 0) as ${c.field}`).join(', ');

    // Note: field names are hardcoded constants, safe to interpolate
    const players = runQueryFullParams(`
      SELECT name, team, ${selectFields}
      FROM players
      WHERE year = ? AND position = ?
      ORDER BY COALESCE(${sortField}, 0) ${sortOrder}
      LIMIT 50
    `, [selectedYear, position]);

    if (players.length === 0) {
      leadersContent.innerHTML = `
        <div class="no-data">
          <div class="no-data-icon"></div>
          <div>No players found</div>
        </div>
      `;
      return;
    }

    // Build grid template
    const gridCols = `40px 1fr ${columns.map(() => '70px').join(' ')}`;

    // Header
    const headerCols = columns.map(c => {
      const isActive = c.field === sortField;
      const indicator = isActive ? `<span class="sort-indicator">${sortIndicator}</span>` : '';
      return `<div class="col-stat${isActive ? ' active' : ''}" data-field="${c.field}">${c.label}${indicator}</div>`;
    }).join('');

    // Rows
    const rows = players.map((p, i) => {
      const rank = i + 1;
      const rankClass = rank <= 3 ? `rank-${rank}` : '';
      const statCols = columns.map(c => {
        const isActive = c.field === sortField;
        const val = p[c.field] || 0;
        return `<div class="col-stat${isActive ? ' active' : ''}">${val.toLocaleString()}</div>`;
      }).join('');

      return `
        <div class="player-row ${rankClass}" style="grid-template-columns: ${gridCols}">
          <div class="col-rank">${rank}</div>
          <div class="col-player">
            <div class="player-name">${p.name}</div>
            <div class="player-team">${p.team}</div>
          </div>
          ${statCols}
        </div>
      `;
    }).join("");

    leadersContent.innerHTML = `
      <div class="leaders-table">
        <div class="table-header" style="grid-template-columns: ${gridCols}">
          <div class="col-rank">#</div>
          <div class="col-player">Player</div>
          ${headerCols}
        </div>
        ${rows}
      </div>
    `;

    // Add click handlers to stat columns
    leadersContent.querySelectorAll('.table-header .col-stat').forEach(col => {
      col.addEventListener('click', () => handleSort(col.dataset.field));
    });
  }

  function handleSort(field) {
    if (sortField === field) {
      sortAscending = !sortAscending;
    } else {
      sortField = field;
      sortAscending = false;
    }
    // Save sort preference
    try {
      localStorage.setItem(STORAGE_KEY_SORT, `${sortField}:${sortAscending ? 'asc' : 'desc'}`);
    } catch(e) {}
    renderLeaders();
  }

  function loadYears() {
    const years = runQueryFullParams(`SELECT DISTINCT year FROM players ORDER BY year DESC`);

    yearSelect.innerHTML = '';
    years.forEach(y => {
      const opt = document.createElement("option");
      opt.value = y.year;
      opt.textContent = y.year;
      yearSelect.appendChild(opt);
    });

    try {
      const savedYear = localStorage.getItem(STORAGE_KEY_YEAR);
      if (savedYear && years.some(y => String(y.year) === savedYear)) {
        selectedYear = parseInt(savedYear);
        yearSelect.value = savedYear;
      } else if (years.length > 0) {
        selectedYear = years[0].year;
        yearSelect.value = selectedYear;
      }
    } catch(e) {
      if (years.length > 0) {
        selectedYear = years[0].year;
        yearSelect.value = selectedYear;
      }
    }
  }

  async function initDB() {
    try {
      const SQL = await initSqlJs({
        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
      });

      statusEl.textContent = "Downloading database...";
      const response = await fetch("nfl.db");
      if (!response.ok) throw new Error("Could not load nfl.db");

      const buffer = await response.arrayBuffer();
      db = new SQL.Database(new Uint8Array(buffer));

      loadYears();
      populatePositions();

      const countStmt = db.prepare("SELECT COUNT(*) FROM players WHERE year = ?");
      countStmt.bind([selectedYear]);
      countStmt.step();
      const playerCount = countStmt.get()[0] || 0;
      countStmt.free();

      statusEl.textContent = `${playerCount} players (${selectedYear})`;
      statusEl.className = "status ready";

      if (positionSelect.value) {
        renderLeaders();
      }
    } catch (err) {
      statusEl.textContent = "Error: " + err.message;
      statusEl.className = "status error";
      console.error(err);
    }
  }

  yearSelect.addEventListener("change", (e) => {
    selectedYear = parseInt(e.target.value);
    try { localStorage.setItem(STORAGE_KEY_YEAR, String(selectedYear)); } catch(e) {}

    const countStmt = db.prepare("SELECT COUNT(*) FROM players WHERE year = ?");
    countStmt.bind([selectedYear]);
    countStmt.step();
    const playerCount = countStmt.get()[0] || 0;
    countStmt.free();
    statusEl.textContent = `${playerCount} players (${selectedYear})`;

    renderLeaders();
  });

  positionSelect.addEventListener("change", (e) => {
    const pos = e.target.value;
    try { localStorage.setItem(STORAGE_KEY_POS, pos); } catch(e) {}

    // Reset to default sort for new position
    if (pos && POSITIONS[pos]) {
      sortField = POSITIONS[pos].defaultSort;
      sortAscending = false;
      try { localStorage.removeItem(STORAGE_KEY_SORT); } catch(e) {}
    }

    renderLeaders();
  });

  initDB();
</script>
</body>
</html>
