<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NFL Roster Quiz - Stats Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèà</text></svg>" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-deep: #030712;
      --bg-card: #0f172a;
      --bg-elevated: #1e293b;
      --accent: #dc2626;
      --accent-glow: rgba(220, 38, 38, 0.4);
      --accent-subtle: rgba(220, 38, 38, 0.15);
      --success: #22c55e;
      --error: #dc2626;
      --warning: #0ea5e9;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border-subtle: rgba(148, 163, 184, 0.15);
      --border-accent: rgba(220, 38, 38, 0.5);
    }

    body {
      font-family: 'Source Sans 3', system-ui, sans-serif;
      background: var(--bg-deep);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    .bg-layer {
      position: fixed;
      inset: 0;
      z-index: -1;
      background:
        radial-gradient(ellipse 80% 60% at 50% 0%, rgba(220, 38, 38, 0.08), transparent 50%),
        radial-gradient(ellipse 60% 40% at 100% 100%, rgba(220, 38, 38, 0.05), transparent),
        var(--bg-deep);
    }

    .container {
      max-width: 580px;
      margin: 0 auto;
      padding: 2rem 1.25rem 3rem;
    }

    header {
      text-align: center;
      margin-bottom: 1.25rem;
    }

    h1 {
      font-family: 'Oswald', sans-serif;
      font-size: 1.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 0.25rem;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      padding: 0.875rem 1rem;
      background: var(--bg-card);
      border-radius: 10px;
      border: 1px solid var(--border-subtle);
      margin-bottom: 1rem;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-family: 'Oswald', sans-serif;
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--accent);
    }

    .stat-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
    }

    /* Question card */
    .question-card {
      position: relative;
      padding: 1.5rem;
      border-radius: 14px;
      background: linear-gradient(145deg, rgba(220, 38, 38, 0.12), var(--bg-card) 40%);
      border: 1px solid var(--border-accent);
      box-shadow:
        0 4px 20px rgba(0, 0, 0, 0.3),
        0 0 40px var(--accent-subtle);
    }

    .question-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), transparent);
      border-radius: 14px 14px 0 0;
    }

    .question-main {
      font-family: 'Oswald', sans-serif;
      font-size: 1.5rem;
      font-weight: 500;
      text-align: center;
      margin-bottom: 1.25rem;
      letter-spacing: 0.01em;
    }

    .answer-input {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .answer-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .rank-label {
      width: 1.5rem;
      font-family: 'Oswald', sans-serif;
      font-size: 1rem;
      font-weight: 500;
      color: var(--accent);
      text-align: right;
    }

    .answer-row input {
      flex: 1;
      background: var(--bg-deep);
      border: 1px solid var(--border-subtle);
      border-radius: 8px;
      color: var(--text-primary);
      padding: 0.6rem 0.85rem;
      font-family: inherit;
      font-size: 0.95rem;
      transition: all 0.2s ease;
    }

    .answer-row input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-subtle);
    }

    .answer-row input.correct {
      border-color: var(--success);
      background: rgba(34, 197, 94, 0.15);
    }

    .answer-row input.wrong {
      border-color: var(--error);
      background: rgba(220, 38, 38, 0.15);
    }

    .answer-row input.partial {
      border-color: var(--warning);
      background: rgba(14, 165, 233, 0.15);
    }

    .answer-row .result {
      font-size: 0.8rem;
      min-width: 110px;
    }

    .answer-row .result.correct { color: #86efac; }
    .answer-row .result.wrong { color: #fca5a5; }
    .answer-row .result.partial { color: #7dd3fc; }

    button.primary {
      width: 100%;
      border-radius: 8px;
      padding: 0.85rem 1rem;
      border: none;
      cursor: pointer;
      font-family: 'Oswald', sans-serif;
      font-size: 1rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: linear-gradient(135deg, var(--accent), #dc2626);
      color: white;
      box-shadow: 0 4px 15px var(--accent-glow);
      transition: all 0.2s ease;
    }

    button.primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px var(--accent-glow);
    }

    button.primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .feedback {
      margin-top: 1rem;
      padding: 0.875rem 1rem;
      border-radius: 10px;
      font-size: 0.95rem;
      display: none;
      border-left: 3px solid;
    }

    .feedback.visible { display: block; }

    .feedback.good {
      background: rgba(34, 197, 94, 0.12);
      border-left-color: var(--success);
      color: #bbf7d0;
    }

    .feedback.ok {
      background: rgba(14, 165, 233, 0.12);
      border-left-color: var(--warning);
      color: #7dd3fc;
    }

    .feedback.bad {
      background: rgba(220, 38, 38, 0.12);
      border-left-color: var(--error);
      color: #fecaca;
    }

    .footer {
      margin-top: 2rem;
      padding-top: 1.25rem;
      border-top: 1px solid var(--border-subtle);
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .footer a {
      color: var(--text-secondary);
      text-decoration: none;
      transition: color 0.2s ease;
    }

    .footer a:hover {
      color: var(--accent);
    }

    @media (max-width: 500px) {
      .question-main { font-size: 1.25rem; }
      .stats-bar { gap: 1rem; }
      .answer-row {
        flex-wrap: wrap;
      }
      .answer-row input {
        flex: 1 1 calc(100% - 2.5rem);
      }
      .answer-row .result {
        width: 100%;
        padding-left: 2.25rem;
        margin-top: 0.25rem;
      }
    }
  </style>
</head>
<body>
<div class="bg-layer"></div>

<div class="container">
  <header>
    <h1>Stats Quiz</h1>
    <p class="subtitle">Name the league leaders</p>
  </header>

  <div class="stats-bar">
    <div class="stat-item">
      <div class="stat-value" id="seen-count">0</div>
      <div class="stat-label">Asked</div>
    </div>
    <div class="stat-item">
      <div class="stat-value" id="score">0</div>
      <div class="stat-label">Points</div>
    </div>
  </div>

  <div class="question-card">
    <div class="question-main" id="question-main">Loading...</div>
    <div class="answer-input" id="answer-input"></div>
    <button class="primary" id="btn-main">Check</button>
    <div class="feedback" id="feedback"></div>
  </div>

  <div class="footer">
    <a href="index.html">Home</a> ¬∑ <a href="practice.html">Practice</a> ¬∑ <a href="easy.html">Multiple Choice</a> ¬∑ <a href="game.html">Daily</a> ¬∑ <a href="trivia.html">Trivia</a> ¬∑ <a href="team-study.html">Depth Charts</a> ¬∑ <a href="explorer.html">SQL Explorer</a>
  </div>
</div>

<script>
  const STORAGE_KEY = "nflStatsQuiz_v1";
  const DATA_YEAR = 2025;

  const QUESTION_TEMPLATES = [
    {
      text: "Top 5 QBs by passing yards",
      filter: p => p.position === "QB" && (p.stats.pass_yd || 0) > 0,
      sort: p => -(p.stats.pass_yd || 0),
      count: 5,
      statLabel: p => `${p.stats.pass_yd} yds`
    },
    {
      text: "Top 5 QBs by passing TDs",
      filter: p => p.position === "QB" && (p.stats.pass_td || 0) > 0,
      sort: p => -(p.stats.pass_td || 0),
      count: 5,
      statLabel: p => `${p.stats.pass_td} TDs`
    },
    {
      text: "Top 5 RBs by rushing yards",
      filter: p => p.position === "RB" && (p.stats.rush_yd || 0) > 0,
      sort: p => -(p.stats.rush_yd || 0),
      count: 5,
      statLabel: p => `${p.stats.rush_yd} yds`
    },
    {
      text: "Top 5 RBs by rushing TDs",
      filter: p => p.position === "RB" && (p.stats.rush_td || 0) > 0,
      sort: p => -(p.stats.rush_td || 0),
      count: 5,
      statLabel: p => `${p.stats.rush_td} TDs`
    },
    {
      text: "Top 5 WRs by receiving yards",
      filter: p => p.position === "WR" && (p.stats.rec_yd || 0) > 0,
      sort: p => -(p.stats.rec_yd || 0),
      count: 5,
      statLabel: p => `${p.stats.rec_yd} yds`
    },
    {
      text: "Top 5 WRs by receptions",
      filter: p => p.position === "WR" && (p.stats.rec || 0) > 0,
      sort: p => -(p.stats.rec || 0),
      count: 5,
      statLabel: p => `${p.stats.rec} rec`
    },
    {
      text: "Top 5 WRs by receiving TDs",
      filter: p => p.position === "WR" && (p.stats.rec_td || 0) > 0,
      sort: p => -(p.stats.rec_td || 0),
      count: 5,
      statLabel: p => `${p.stats.rec_td} TDs`
    },
    {
      text: "Top 5 TEs by receiving yards",
      filter: p => p.position === "TE" && (p.stats.rec_yd || 0) > 0,
      sort: p => -(p.stats.rec_yd || 0),
      count: 5,
      statLabel: p => `${p.stats.rec_yd} yds`
    },
    {
      text: "Top 3 QBs by interceptions thrown",
      filter: p => p.position === "QB" && (p.stats.pass_int || 0) > 0,
      sort: p => -(p.stats.pass_int || 0),
      count: 3,
      statLabel: p => `${p.stats.pass_int} INTs`
    },
    {
      text: "Top 5 players by total TDs",
      filter: p => ((p.stats.rush_td || 0) + (p.stats.rec_td || 0)) > 0,
      sort: p => -((p.stats.rush_td || 0) + (p.stats.rec_td || 0)),
      count: 5,
      statLabel: p => `${(p.stats.rush_td || 0) + (p.stats.rec_td || 0)} TDs`
    },
    {
      text: "Top 5 tacklers",
      filter: p => (p.stats.idp_tkl || 0) > 0,
      sort: p => -(p.stats.idp_tkl || 0),
      count: 5,
      statLabel: p => `${p.stats.idp_tkl} tkl`
    },
    {
      text: "Top 3 players by sacks",
      filter: p => (p.stats.idp_sack || 0) > 0,
      sort: p => -(p.stats.idp_sack || 0),
      count: 3,
      statLabel: p => `${p.stats.idp_sack} sacks`
    },
  ];

  let allPlayers = [];
  let currentQuestion = null;
  let currentAnswers = [];
  let answered = false;
  let globalStats = { seen: 0, score: 0 };

  const questionMain = document.getElementById("question-main");
  const answerInput = document.getElementById("answer-input");
  const btnMain = document.getElementById("btn-main");
  const feedbackEl = document.getElementById("feedback");
  const seenEl = document.getElementById("seen-count");
  const scoreEl = document.getElementById("score");

  function normalizeString(str) {
    return String(str || "").trim().toLowerCase().replace(/[^a-z]/g, "");
  }

  function levenshtein(a, b) {
    const m = a.length, n = b.length;
    const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
    for (let i = 0; i <= m; i++) dp[i][0] = i;
    for (let j = 0; j <= n; j++) dp[0][j] = j;
    for (let i = 1; i <= m; i++) {
      for (let j = 1; j <= n; j++) {
        if (a[i-1] === b[j-1]) dp[i][j] = dp[i-1][j-1];
        else dp[i][j] = 1 + Math.min(dp[i-1][j], dp[i][j-1], dp[i-1][j-1]);
      }
    }
    return dp[m][n];
  }

  function fuzzyMatch(guess, correct) {
    if (!guess || !correct) return false;
    if (guess === correct) return true;
    if (correct.endsWith(guess) && guess.length >= 5) return true;
    const len = correct.length;
    if (len <= 3) return false;
    const dist = levenshtein(guess, correct);
    const maxDist = len <= 6 ? 1 : 2;
    return dist <= maxDist;
  }

  function loadStats() {
    try {
      const s = localStorage.getItem(STORAGE_KEY);
      if (s) globalStats = JSON.parse(s);
    } catch(e) {}
    updateStatsUI();
  }

  function saveStats() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(globalStats));
    } catch(e) {}
  }

  function updateStatsUI() {
    seenEl.textContent = globalStats.seen;
    scoreEl.textContent = globalStats.score;
  }

  function pickQuestion() {
    const template = QUESTION_TEMPLATES[Math.floor(Math.random() * QUESTION_TEMPLATES.length)];
    const filtered = allPlayers.filter(template.filter);
    filtered.sort((a, b) => template.sort(a) - template.sort(b));
    const topPlayers = filtered.slice(0, template.count);

    if (topPlayers.length < template.count) {
      return pickQuestion();
    }

    return {
      text: template.text,
      answers: topPlayers,
      statLabel: template.statLabel,
      count: template.count
    };
  }

  function showQuestion() {
    currentQuestion = pickQuestion();
    currentAnswers = currentQuestion.answers;
    answered = false;

    questionMain.textContent = `${currentQuestion.text} (${DATA_YEAR})`;

    answerInput.innerHTML = "";
    for (let i = 0; i < currentQuestion.count; i++) {
      const row = document.createElement("div");
      row.className = "answer-row";
      row.innerHTML = `
        <span class="rank-label">${i + 1}.</span>
        <input type="text" id="answer-${i}" placeholder="Player name" autocomplete="off" />
        <span class="result" id="result-${i}"></span>
      `;
      answerInput.appendChild(row);
    }

    document.getElementById("answer-0")?.focus();

    btnMain.textContent = "Check";
    feedbackEl.className = "feedback";
  }

  function checkAnswers() {
    if (answered) {
      showQuestion();
      return;
    }

    answered = true;
    let correctCount = 0;
    const guessedNames = new Set();

    for (let i = 0; i < currentQuestion.count; i++) {
      const input = document.getElementById(`answer-${i}`);
      const resultEl = document.getElementById(`result-${i}`);
      const guess = normalizeString(input.value);
      const correctPlayer = currentAnswers[i];
      const correctName = normalizeString(correctPlayer.name);

      const matchedPlayer = currentAnswers.find(p =>
        fuzzyMatch(guess, normalizeString(p.name)) && !guessedNames.has(normalizeString(p.name))
      );

      if (matchedPlayer) {
        guessedNames.add(normalizeString(matchedPlayer.name));
        if (normalizeString(matchedPlayer.name) === correctName) {
          input.className = "correct";
          resultEl.className = "result correct";
          resultEl.textContent = `‚úì ${currentQuestion.statLabel(correctPlayer)}`;
          correctCount++;
        } else {
          input.className = "partial";
          resultEl.className = "result partial";
          resultEl.textContent = `~ wrong spot (+0.5)`;
          correctCount += 0.5;
        }
      } else {
        input.className = "wrong";
        resultEl.className = "result wrong";
        resultEl.textContent = `‚úó ${correctPlayer.name}`;
      }
    }

    globalStats.seen++;
    globalStats.score += Math.floor(correctCount);
    saveStats();
    updateStatsUI();

    const pct = correctCount / currentQuestion.count;
    if (pct >= 0.8) {
      feedbackEl.className = "feedback visible good";
      feedbackEl.textContent = `Great! ${Math.floor(correctCount)}/${currentQuestion.count} correct`;
    } else if (pct >= 0.4) {
      feedbackEl.className = "feedback visible ok";
      feedbackEl.textContent = `Not bad! ${Math.floor(correctCount)}/${currentQuestion.count} correct`;
    } else {
      feedbackEl.className = "feedback visible bad";
      feedbackEl.textContent = `${Math.floor(correctCount)}/${currentQuestion.count} correct. Keep practicing!`;
    }

    btnMain.textContent = "Next Question";
  }

  async function loadPlayers() {
    try {
      const resp = await fetch(`players-with-stats-${DATA_YEAR}.json`, { cache: "no-store" });
      if (!resp.ok) throw new Error("HTTP " + resp.status);
      const parsed = await resp.json();

      allPlayers = parsed
        .map(p => ({
          name: String(p.name || "").trim(),
          team: String(p.team || "").trim(),
          position: String(p.position || "").trim(),
          stats: p.stats || {}
        }))
        .filter(p => p.name && p.team && p.position);

      showQuestion();
    } catch (err) {
      questionMain.textContent = "Could not load players: " + err.message;
    }
  }

  btnMain.addEventListener("click", checkAnswers);

  document.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      if (answered) {
        showQuestion();
      } else {
        const focused = document.activeElement;
        if (focused && focused.id?.startsWith("answer-")) {
          const idx = parseInt(focused.id.split("-")[1]);
          const next = document.getElementById(`answer-${idx + 1}`);
          if (next) {
            next.focus();
          } else {
            checkAnswers();
          }
        } else {
          checkAnswers();
        }
      }
    }
  });

  loadStats();
  loadPlayers();
</script>
</body>
</html>
