<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Matchup Predictions</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üèà</text></svg>" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;600;700&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="odds-engine.js"></script>
  <script src="chart-utils.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-deep: #030712;
      --bg-card: #0c1322;
      --bg-hover: #111827;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --border: #1e293b;
      --accent: #3b82f6;
      --positive: #22c55e;
      --negative: #ef4444;
      --warning: #d97706;
      --purple: #a855f7;
      --team1: #3b82f6;
      --team2: #d97706;
    }

    body {
      font-family: 'Source Sans 3', system-ui, sans-serif;
      background: var(--bg-deep);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 1.5rem 1rem 2rem;
    }

    header { text-align: center; margin-bottom: 1.5rem; }

    h1 {
      font-family: 'Oswald', sans-serif;
      font-size: 1.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      margin-bottom: 0.25rem;
    }

    .subtitle { font-size: 0.9rem; color: var(--text-secondary); }

    .back-link {
      display: inline-block;
      color: var(--accent);
      text-decoration: none;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    .back-link:hover { text-decoration: underline; }

    .controls {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .controls select {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      padding: 0.6rem 1rem;
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .matchup-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
      margin-bottom: 1.5rem;
    }

    .matchup-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .matchup-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .matchup-card.selected {
      border-color: var(--accent);
      background: rgba(59, 130, 246, 0.1);
    }

    .matchup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .matchup-teams {
      font-family: 'Oswald', sans-serif;
      font-size: 1.2rem;
      font-weight: 600;
    }

    .matchup-teams .at { color: var(--text-muted); font-weight: 400; margin: 0 0.25rem; }

    .matchup-date {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .matchup-odds {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      text-align: center;
    }

    .odds-item {
      background: var(--bg-deep);
      border-radius: 6px;
      padding: 0.5rem;
    }

    .odds-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .odds-value {
      font-family: 'Oswald', sans-serif;
      font-size: 1rem;
      font-weight: 600;
    }

    .odds-value.favorite { color: var(--positive); }

    .win-prob-bar {
      height: 4px;
      background: linear-gradient(to right, var(--negative), var(--negative));
      border-radius: 2px;
      position: relative;
      margin-top: 0.75rem;
      overflow: hidden;
    }

    .win-prob-fill {
      height: 100%;
      background: var(--positive);
      border-radius: 2px;
      position: absolute;
      right: 0;
      top: 0;
    }

    .win-prob-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    /* Detail section - aligned with card style */
    .detail-section {
      background: var(--bg-card);
      border: 1px solid var(--accent);
      border-radius: 10px;
      margin-bottom: 1.5rem;
      overflow: hidden;
    }

    .detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 1.25rem 0.75rem;
    }

    .detail-teams {
      font-family: 'Oswald', sans-serif;
      font-size: 1.3rem;
      font-weight: 600;
    }

    .detail-teams .at {
      color: var(--text-muted);
      font-weight: 400;
      margin: 0 0.25rem;
    }

    .detail-date {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .detail-odds {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.5rem;
      padding: 0 1.25rem;
      text-align: center;
    }

    .detail-odds .odds-item {
      background: var(--bg-deep);
      border-radius: 6px;
      padding: 0.6rem 0.5rem;
    }

    .detail-prob {
      padding: 0.75rem 1.25rem;
    }

    .detail-ranges {
      display: flex;
      gap: 1.5rem;
      padding: 0 1.25rem 1rem;
      font-size: 0.8rem;
    }

    .range-item {
      display: flex;
      gap: 0.35rem;
    }

    .range-label {
      color: var(--text-muted);
    }

    .range-value {
      color: var(--text-secondary);
    }

    .detail-content {
      padding: 1.25rem;
      border-top: 1px solid var(--border);
    }

    .model-inputs {
      background: var(--bg-deep);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }

    .model-inputs-title {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.5rem;
    }

    .model-inputs-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .model-inputs-grid span { color: var(--text-muted); }

    /* H2H Section */
    .h2h-section {
      border-top: 1px solid var(--border);
      padding-top: 1.25rem;
      margin-top: 1rem;
    }

    .h2h-title {
      font-family: 'Oswald', sans-serif;
      font-size: 1rem;
      font-weight: 500;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }

    .h2h-summary {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 1rem;
      text-align: center;
      margin-bottom: 1rem;
    }

    .h2h-team {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .h2h-team .code {
      font-family: 'Oswald', sans-serif;
      font-size: 1.25rem;
      font-weight: 600;
    }

    .h2h-team.team1 .code { color: var(--team1); }
    .h2h-team.team2 .code { color: var(--team2); }

    .h2h-team .wins {
      font-family: 'Oswald', sans-serif;
      font-size: 2rem;
      font-weight: 700;
    }

    .h2h-team .ppg {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .h2h-vs {
      display: flex;
      align-items: center;
      color: var(--text-muted);
    }

    .h2h-games-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    .h2h-games-table th,
    .h2h-games-table td {
      padding: 0.5rem;
      text-align: center;
      border-bottom: 1px solid var(--border);
    }

    .h2h-games-table th {
      font-size: 0.7rem;
      text-transform: uppercase;
      color: var(--text-muted);
      background: var(--bg-deep);
    }

    .h2h-games-table tr:hover { background: var(--bg-hover); }

    .winner-home { color: var(--team1); font-weight: 600; }
    .winner-away { color: var(--team2); font-weight: 600; }

    .chart-container {
      height: 200px;
      margin-top: 1rem;
    }

    .no-data {
      padding: 2rem;
      text-align: center;
      color: var(--text-muted);
    }

    .loading {
      text-align: center;
      color: var(--text-muted);
      padding: 2rem;
    }

    .detail-links {
      padding: 1rem 0;
      border-top: 1px solid var(--border);
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
      justify-content: center;
    }

    .detail-link {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.5rem 1rem;
      background: var(--bg-deep);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 0.85rem;
      transition: all 0.15s ease;
    }

    .detail-link:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    @media (max-width: 600px) {
      .matchup-grid { grid-template-columns: 1fr; }
      .h2h-summary { grid-template-columns: 1fr 1fr; }
      .h2h-vs { display: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="index.html" class="back-link">&larr; Back to Home</a>

    <header>
      <h1>Matchup Predictions</h1>
      <p class="subtitle">Model-based odds with historical context</p>
    </header>

    <div class="controls">
      <select id="season-select">
        <option value="2025">2025 Season</option>
        <option value="2024">2024 Season</option>
      </select>
      <select id="week-select">
        <option value="">Loading...</option>
      </select>
    </div>

    <div id="matchup-grid" class="matchup-grid">
      <div class="loading">Loading matchups...</div>
    </div>

    <div id="detail-section" class="detail-section" style="display: none;">
      <!-- Compact header matching card style -->
      <div class="detail-header">
        <div class="detail-teams" id="detail-title">DEN @ LV</div>
        <div class="detail-date" id="detail-date">Sat, Dec 6</div>
      </div>

      <!-- Odds row matching card layout -->
      <div class="detail-odds">
        <div class="odds-item">
          <div class="odds-label">Spread</div>
          <div class="odds-value" id="pred-spread">--</div>
        </div>
        <div class="odds-item">
          <div class="odds-label">Total</div>
          <div class="odds-value" id="pred-total">--</div>
        </div>
        <div class="odds-item">
          <div class="odds-label" id="pred-home-label">Home ML</div>
          <div class="odds-value" id="pred-home-ml">--</div>
        </div>
        <div class="odds-item">
          <div class="odds-label" id="pred-away-label">Away ML</div>
          <div class="odds-value" id="pred-away-ml">--</div>
        </div>
      </div>

      <!-- Win probability bar -->
      <div class="detail-prob">
        <div class="win-prob-bar">
          <div class="win-prob-fill" id="detail-prob-fill" style="width: 50%;"></div>
        </div>
        <div class="win-prob-labels">
          <span id="detail-away-prob">AWAY 50%</span>
          <span id="detail-home-prob">HOME 50%</span>
        </div>
      </div>

      <!-- Confidence intervals - both SRS-adjusted and raw PPG -->
      <div class="detail-ranges">
        <div class="range-item">
          <span class="range-label">Spread 90% CI (SRS):</span>
          <span class="range-value" id="pred-spread-range">--</span>
        </div>
        <div class="range-item">
          <span class="range-label">Spread 90% CI (Raw PPG):</span>
          <span class="range-value" id="pred-spread-range-raw">--</span>
        </div>
        <div class="range-item">
          <span class="range-label">Total 90% CI (SRS):</span>
          <span class="range-value" id="pred-total-range">--</span>
        </div>
        <div class="range-item">
          <span class="range-label">Total 90% CI (Raw PPG):</span>
          <span class="range-value" id="pred-total-range-raw">--</span>
        </div>
      </div>

      <div class="detail-content">
        <div class="model-inputs" id="model-inputs">
          <div class="model-inputs-title">Model Inputs</div>
          <div class="model-inputs-grid" id="model-inputs-grid"></div>
        </div>

        <div class="chart-container">
          <canvas id="distribution-chart"></canvas>
        </div>

        <div class="h2h-section" id="h2h-section">
          <div class="h2h-title">Head-to-Head History (2020-2025)</div>
          <div id="h2h-content">
            <div class="no-data">No historical games found</div>
          </div>
        </div>

        <div class="detail-links">
          <a href="#" id="lineup-link" class="detail-link">üèüÔ∏è View Lineups</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    let db = null;
    let distributionChart = null;
    let h2hChart = null;
    let currentMatchups = [];

    // NFL week date ranges (Tuesday start of each week)
    // 2025 season: Week 1 starts Sept 4 (Thursday opener), week ends following Monday
    const NFL_WEEK_STARTS = {
      2025: [
        new Date('2025-09-02'), // Week 1: Sept 4-8
        new Date('2025-09-09'), // Week 2
        new Date('2025-09-16'), // Week 3
        new Date('2025-09-23'), // Week 4
        new Date('2025-09-30'), // Week 5
        new Date('2025-10-07'), // Week 6
        new Date('2025-10-14'), // Week 7
        new Date('2025-10-21'), // Week 8
        new Date('2025-10-28'), // Week 9
        new Date('2025-11-04'), // Week 10
        new Date('2025-11-11'), // Week 11
        new Date('2025-11-18'), // Week 12
        new Date('2025-11-25'), // Week 13
        new Date('2025-12-02'), // Week 14
        new Date('2025-12-09'), // Week 15
        new Date('2025-12-16'), // Week 16
        new Date('2025-12-23'), // Week 17
        new Date('2025-12-30'), // Week 18
      ],
      2024: [
        new Date('2024-09-03'), // Week 1
        new Date('2024-09-10'),
        new Date('2024-09-17'),
        new Date('2024-09-24'),
        new Date('2024-10-01'),
        new Date('2024-10-08'),
        new Date('2024-10-15'),
        new Date('2024-10-22'),
        new Date('2024-10-29'),
        new Date('2024-11-05'),
        new Date('2024-11-12'),
        new Date('2024-11-19'),
        new Date('2024-11-26'),
        new Date('2024-12-03'),
        new Date('2024-12-10'),
        new Date('2024-12-17'),
        new Date('2024-12-24'),
        new Date('2024-12-31'),
      ]
    };

    function getCurrentNFLWeek(season) {
      const today = new Date();
      const weeks = NFL_WEEK_STARTS[season];
      if (!weeks) return null;

      // Find the current week by checking which range today falls into
      for (let i = weeks.length - 1; i >= 0; i--) {
        if (today >= weeks[i]) {
          return i + 1; // weeks are 1-indexed
        }
      }

      // Before season starts, return week 1
      return 1;
    }

    async function initDB() {
      const SQL = await initSqlJs({
        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/${file}`
      });

      const response = await fetch('nfl.db?' + Date.now());
      const buffer = await response.arrayBuffer();
      db = new SQL.Database(new Uint8Array(buffer));

      const season = document.getElementById('season-select').value;
      await OddsEngine.loadAdvancedStats(parseInt(season));

      populateWeekSelect();
    }

    function populateWeekSelect() {
      const season = parseInt(document.getElementById('season-select').value);
      const result = db.exec(`
        SELECT DISTINCT week FROM games
        WHERE season = ${season}
        ORDER BY week ASC
      `);

      const select = document.getElementById('week-select');
      select.innerHTML = '';

      if (result.length && result[0].values.length) {
        const availableWeeks = result[0].values.map(r => r[0]);
        const currentWeek = getCurrentNFLWeek(season);

        // Find best week to show: current week if available, else closest available
        let selectedWeek = availableWeeks[availableWeeks.length - 1]; // fallback to latest
        if (currentWeek && availableWeeks.includes(currentWeek)) {
          selectedWeek = currentWeek;
        } else if (currentWeek) {
          // Find closest available week
          for (let i = availableWeeks.length - 1; i >= 0; i--) {
            if (availableWeeks[i] <= currentWeek) {
              selectedWeek = availableWeeks[i];
              break;
            }
          }
        }

        availableWeeks.forEach(week => {
          const opt = document.createElement('option');
          opt.value = week;
          opt.textContent = `Week ${week}`;
          if (week === selectedWeek) opt.selected = true;
          select.appendChild(opt);
        });

        loadMatchups(selectedWeek);
      }
    }

    function loadMatchups(week) {
      const season = document.getElementById('season-select').value;

      const sql = `
        SELECT
          g.week, g.game_date, g.home_team, g.away_team, g.is_completed,
          g.home_score, g.away_score,
          ts_home.ppg_scored as home_ppg, ts_home.ppg_allowed as home_allowed,
          ts_home.scoring_std_dev as home_std, ts_home.last_5_ppg as home_last5,
          ts_home.last_5_ppg_allowed as home_last5_allowed,
          ts_home.ema_differential as home_ema, ts_home.scoring_changepoint as home_cp,
          ts_home.scoring_changepoint_direction as home_cp_dir,
          ts_away.ppg_scored as away_ppg, ts_away.ppg_allowed as away_allowed,
          ts_away.scoring_std_dev as away_std, ts_away.last_5_ppg as away_last5,
          ts_away.last_5_ppg_allowed as away_last5_allowed,
          ts_away.ema_differential as away_ema, ts_away.scoring_changepoint as away_cp,
          ts_away.scoring_changepoint_direction as away_cp_dir
        FROM games g
        LEFT JOIN team_stats ts_home ON g.home_team = ts_home.team_code AND ts_home.season = ${season}
        LEFT JOIN team_stats ts_away ON g.away_team = ts_away.team_code AND ts_away.season = ${season}
        WHERE g.season = ${season} AND g.week = ${week}
        ORDER BY g.game_date
      `;

      const result = db.exec(sql);
      const grid = document.getElementById('matchup-grid');

      if (!result.length || !result[0].values.length) {
        grid.innerHTML = '<div class="no-data">No games this week</div>';
        currentMatchups = [];
        return;
      }

      const cols = result[0].columns;
      currentMatchups = result[0].values.map(row => {
        const g = {};
        cols.forEach((col, i) => g[col] = row[i]);
        return g;
      });

      renderMatchupCards();
    }

    function renderMatchupCards() {
      const grid = document.getElementById('matchup-grid');

      grid.innerHTML = currentMatchups.map((g, idx) => {
        const homeStats = {
          team_code: g.home_team,
          ppg_scored: g.home_ppg || 21,
          ppg_allowed: g.home_allowed || 21,
          scoring_std_dev: g.home_std || 10,
          last_5_ppg: g.home_last5,
          last_5_ppg_allowed: g.home_last5_allowed,
          ema_differential: g.home_ema,
          scoring_changepoint: g.home_cp,
          scoring_changepoint_direction: g.home_cp_dir,
        };

        const awayStats = {
          team_code: g.away_team,
          ppg_scored: g.away_ppg || 21,
          ppg_allowed: g.away_allowed || 21,
          scoring_std_dev: g.away_std || 10,
          last_5_ppg: g.away_last5,
          last_5_ppg_allowed: g.away_last5_allowed,
          ema_differential: g.away_ema,
          scoring_changepoint: g.away_cp,
          scoring_changepoint_direction: g.away_cp_dir,
        };

        const odds = OddsEngine.calculateMatchupOdds(homeStats, awayStats);
        g._odds = odds;
        g._homeStats = homeStats;
        g._awayStats = awayStats;

        const dateStr = g.game_date ? new Date(g.game_date).toLocaleDateString('en-US', {
          weekday: 'short', month: 'short', day: 'numeric'
        }) : '';

        const homeProb = Math.round(odds.homeWinProb * 100);
        const awayProb = 100 - homeProb;

        const spreadDisplay = odds.spread <= 0
          ? `${g.home_team} ${odds.spread}`
          : `${g.away_team} ${-odds.spread}`;

        const favoriteML = odds.homeWinProb >= 0.5 ? odds.homeMoneyline : odds.awayMoneyline;

        let status = '';
        if (g.is_completed) {
          status = `<div style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem;">Final: ${g.away_score} - ${g.home_score}</div>`;
        }

        return `
          <div class="matchup-card" data-idx="${idx}">
            <div class="matchup-header">
              <div class="matchup-teams">${g.away_team}<span class="at">@</span>${g.home_team}</div>
              <div class="matchup-date">${dateStr}</div>
            </div>
            <div class="matchup-odds">
              <div class="odds-item">
                <div class="odds-label">Spread</div>
                <div class="odds-value">${spreadDisplay}</div>
              </div>
              <div class="odds-item">
                <div class="odds-label">Total</div>
                <div class="odds-value">${odds.overUnder}</div>
              </div>
              <div class="odds-item">
                <div class="odds-label">Fav ML</div>
                <div class="odds-value favorite">${formatOdds(favoriteML)}</div>
              </div>
            </div>
            <div class="win-prob-bar">
              <div class="win-prob-fill" style="width: ${homeProb}%;"></div>
            </div>
            <div class="win-prob-labels">
              <span>${g.away_team} ${awayProb}%</span>
              <span>${g.home_team} ${homeProb}%</span>
            </div>
            ${status}
          </div>
        `;
      }).join('');

      // Add click handlers
      grid.querySelectorAll('.matchup-card').forEach(card => {
        card.addEventListener('click', () => {
          const idx = parseInt(card.dataset.idx);
          grid.querySelectorAll('.matchup-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          showMatchupDetail(idx);
        });
      });
    }

    function showMatchupDetail(idx) {
      const g = currentMatchups[idx];
      if (!g) return;

      const section = document.getElementById('detail-section');
      section.style.display = 'block';

      const enhanced = OddsEngine.calculateEnhancedOdds(g._homeStats, g._awayStats);
      const homeProb = Math.round(enhanced.homeWinProb * 100);
      const awayProb = 100 - homeProb;

      // Header
      document.getElementById('detail-title').innerHTML =
        `${g.away_team}<span class="at">@</span>${g.home_team}`;

      const dateStr = g.game_date ? new Date(g.game_date).toLocaleDateString('en-US', {
        weekday: 'short', month: 'short', day: 'numeric'
      }) : '';
      document.getElementById('detail-date').textContent = dateStr;

      // Odds
      document.getElementById('pred-spread').textContent = OddsEngine.formatSpread(enhanced.spread);
      document.getElementById('pred-total').textContent = enhanced.overUnder.toFixed(1);
      document.getElementById('pred-home-label').textContent = `${g.home_team} ML`;
      document.getElementById('pred-home-ml').textContent = formatOdds(enhanced.homeMoneyline);
      document.getElementById('pred-away-label').textContent = `${g.away_team} ML`;
      document.getElementById('pred-away-ml').textContent = formatOdds(enhanced.awayMoneyline);

      // Win probability bar
      document.getElementById('detail-prob-fill').style.width = `${homeProb}%`;
      document.getElementById('detail-away-prob').textContent = `${g.away_team} ${awayProb}%`;
      document.getElementById('detail-home-prob').textContent = `${g.home_team} ${homeProb}%`;

      // Confidence intervals - SRS-adjusted
      document.getElementById('pred-spread-range').textContent =
        `${enhanced.simulation.spreadRange.low} to ${enhanced.simulation.spreadRange.high}`;
      document.getElementById('pred-total-range').textContent =
        `${enhanced.simulation.totalRange.low} to ${enhanced.simulation.totalRange.high}`;
      // Confidence intervals - Raw PPG
      document.getElementById('pred-spread-range-raw').textContent =
        `${enhanced.rawSimulation.spreadRange.low} to ${enhanced.rawSimulation.spreadRange.high}`;
      document.getElementById('pred-total-range-raw').textContent =
        `${enhanced.rawSimulation.totalRange.low} to ${enhanced.rawSimulation.totalRange.high}`;

      // Model inputs
      const homeAdv = OddsEngine.getAdvancedStats(g.home_team);
      const awayAdv = OddsEngine.getAdvancedStats(g.away_team);

      let inputsHtml = '';
      if (homeAdv && awayAdv) {
        inputsHtml = `
          <div><span>${g.home_team} SRS:</span> ${homeAdv.srs >= 0 ? '+' : ''}${homeAdv.srs?.toFixed(1)}</div>
          <div><span>${g.away_team} SRS:</span> ${awayAdv.srs >= 0 ? '+' : ''}${awayAdv.srs?.toFixed(1)}</div>
          <div><span>Home Field:</span> +${enhanced.homeFieldAdvantage || 2.5} pts</div>
          <div><span>Power Diff:</span> ${(enhanced.homePower - enhanced.awayPower).toFixed(1)}</div>
          <div><span>${g.home_team} SOS:</span> ${homeAdv.sos?.toFixed(3)}</div>
          <div><span>${g.away_team} SOS:</span> ${awayAdv.sos?.toFixed(3)}</div>
        `;
      } else {
        inputsHtml = `
          <div><span>${g.home_team} PPG:</span> ${g._homeStats.ppg_scored?.toFixed(1)}</div>
          <div><span>${g.away_team} PPG:</span> ${g._awayStats.ppg_scored?.toFixed(1)}</div>
          <div><span>${g.home_team} Allowed:</span> ${g._homeStats.ppg_allowed?.toFixed(1)}</div>
          <div><span>${g.away_team} Allowed:</span> ${g._awayStats.ppg_allowed?.toFixed(1)}</div>
        `;
      }
      document.getElementById('model-inputs-grid').innerHTML = inputsHtml;

      // Distribution chart
      renderDistributionChart(g._homeStats, g._awayStats, g.home_team);

      // H2H history
      loadH2HHistory(g.home_team, g.away_team);

      // Set lineup viewer link
      document.getElementById('lineup-link').href =
        `lineup-viewer.html?away=${g.away_team}&home=${g.home_team}`;

      section.scrollIntoView({ behavior: 'smooth' });
    }

    function renderDistributionChart(homeStats, awayStats, homeTeam) {
      if (distributionChart) distributionChart.destroy();

      const ctx = document.getElementById('distribution-chart');
      const sim = OddsEngine.monteCarloSimulation(homeStats, awayStats, { iterations: 2000 });

      const spreadBins = [
        { label: '-20+', count: 0 },
        { label: '-15', count: 0 },
        { label: '-10', count: 0 },
        { label: '-7', count: 0 },
        { label: '-3', count: 0 },
        { label: 'PK', count: 0 },
        { label: '+3', count: 0 },
        { label: '+7', count: 0 },
        { label: '+10', count: 0 },
        { label: '+15', count: 0 },
        { label: '+20+', count: 0 },
      ];

      for (let i = 0; i < 1000; i++) {
        const margin = sim.spread.mean + (Math.random() - 0.5) * (sim.spread.p95 - sim.spread.p5);
        if (margin <= -17.5) spreadBins[0].count++;
        else if (margin <= -12.5) spreadBins[1].count++;
        else if (margin <= -8.5) spreadBins[2].count++;
        else if (margin <= -5) spreadBins[3].count++;
        else if (margin <= -1.5) spreadBins[4].count++;
        else if (margin <= 1.5) spreadBins[5].count++;
        else if (margin <= 5) spreadBins[6].count++;
        else if (margin <= 8.5) spreadBins[7].count++;
        else if (margin <= 12.5) spreadBins[8].count++;
        else if (margin <= 17.5) spreadBins[9].count++;
        else spreadBins[10].count++;
      }

      distributionChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: spreadBins.map(b => b.label),
          datasets: [{
            label: 'Outcome Probability',
            data: spreadBins.map(b => (b.count / 1000 * 100).toFixed(1)),
            backgroundColor: spreadBins.map((b, i) => {
              if (i < 5) return 'rgba(239, 68, 68, 0.6)';
              if (i > 5) return 'rgba(34, 197, 94, 0.6)';
              return 'rgba(148, 163, 184, 0.6)';
            }),
            borderRadius: 4,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx) => `${ctx.raw}% probability` } }
          },
          scales: {
            x: {
              grid: { color: 'rgba(148, 163, 184, 0.1)' },
              ticks: { color: '#94a3b8' },
              title: { display: true, text: `${homeTeam} Margin`, color: '#94a3b8' }
            },
            y: {
              grid: { color: 'rgba(148, 163, 184, 0.1)' },
              ticks: { color: '#94a3b8' },
              title: { display: true, text: 'Probability %', color: '#94a3b8' }
            }
          }
        }
      });
    }

    function loadH2HHistory(home, away) {
      const games = db.exec(`
        SELECT season, week, game_date, home_team, away_team, home_score, away_score
        FROM games
        WHERE ((home_team = '${home}' AND away_team = '${away}')
           OR (home_team = '${away}' AND away_team = '${home}'))
          AND is_completed = 1
        ORDER BY season DESC, week DESC
        LIMIT 10
      `);

      const container = document.getElementById('h2h-content');

      if (!games.length || !games[0].values.length) {
        container.innerHTML = '<div class="no-data">No historical games between these teams</div>';
        return;
      }

      const rows = games[0].values;
      let homeWins = 0, awayWins = 0, homePts = 0, awayPts = 0;

      rows.forEach(([season, week, date, hTeam, aTeam, hScore, aScore]) => {
        const isHomeTeamHome = hTeam === home;
        const homeTeamScore = isHomeTeamHome ? hScore : aScore;
        const awayTeamScore = isHomeTeamHome ? aScore : hScore;

        homePts += homeTeamScore;
        awayPts += awayTeamScore;

        if (homeTeamScore > awayTeamScore) homeWins++;
        else if (awayTeamScore > homeTeamScore) awayWins++;
      });

      const gamesHtml = rows.map(([season, week, date, hTeam, aTeam, hScore, aScore]) => {
        const isHomeTeamHome = hTeam === home;
        const homeScore = isHomeTeamHome ? hScore : aScore;
        const awayScore = isHomeTeamHome ? aScore : hScore;
        const winner = homeScore > awayScore ? 'home' : awayScore > homeScore ? 'away' : '';

        return `<tr>
          <td>${season} Wk ${week}</td>
          <td>${aTeam} @ ${hTeam}</td>
          <td class="winner-${winner === 'away' ? 'away' : ''}">${awayScore}</td>
          <td class="winner-${winner === 'home' ? 'home' : ''}">${homeScore}</td>
          <td>${homeScore + awayScore}</td>
        </tr>`;
      }).join('');

      container.innerHTML = `
        <div class="h2h-summary">
          <div class="h2h-team team1">
            <div class="code">${home}</div>
            <div class="wins">${homeWins}</div>
            <div class="ppg">${(homePts / rows.length).toFixed(1)} PPG</div>
          </div>
          <div class="h2h-vs">-</div>
          <div class="h2h-team team2">
            <div class="code">${away}</div>
            <div class="wins">${awayWins}</div>
            <div class="ppg">${(awayPts / rows.length).toFixed(1)} PPG</div>
          </div>
        </div>
        <table class="h2h-games-table">
          <thead>
            <tr><th>Game</th><th>Matchup</th><th>${away}</th><th>${home}</th><th>Total</th></tr>
          </thead>
          <tbody>${gamesHtml}</tbody>
        </table>
      `;
    }

    function formatOdds(odds) {
      return odds > 0 ? '+' + odds : String(odds);
    }

    // Event listeners
    document.getElementById('season-select').addEventListener('change', async () => {
      const season = document.getElementById('season-select').value;
      await OddsEngine.loadAdvancedStats(parseInt(season));
      populateWeekSelect();
      document.getElementById('detail-section').style.display = 'none';
    });

    document.getElementById('week-select').addEventListener('change', (e) => {
      loadMatchups(parseInt(e.target.value));
      document.getElementById('detail-section').style.display = 'none';
    });

    // Initialize
    initDB().catch(err => {
      console.error(err);
      document.getElementById('matchup-grid').innerHTML =
        '<div class="no-data">Error loading database</div>';
    });
  </script>
</body>
</html>
